#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” Running pre-push checks..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Get current branch name
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

# ============================================================================
# 1. Check branch naming convention
# ============================================================================
echo ""
echo "1ï¸âƒ£  Checking branch name format..."

# Allow main and properly formatted feature branches (trunk-based development)
if [ "$BRANCH_NAME" != "main" ]; then
  # Check if branch follows naming convention
  if ! echo "$BRANCH_NAME" | grep -qE "^(feature|bugfix|hotfix|refactor|docs|test|chore)/KOM-[0-9]+-[a-z0-9-]+$"; then
    echo "âŒ Branch name does not follow naming convention"
    echo "   Got: $BRANCH_NAME"
    echo ""
    echo "   Required format: <type>/KOM-###-<description>"
    echo "   Examples:"
    echo "     feature/KOM-123-customer-validation"
    echo "     bugfix/KOM-456-invoice-fix"
    echo "     hotfix/KOM-789-security-patch"
    echo ""
    echo "   Or rename your branch:"
    echo "     git branch -m <new-branch-name>"
    echo ""
    exit 1
  fi
  echo "   âœ… Branch name is valid: $BRANCH_NAME"
else
  echo "   âœ… Main branch: $BRANCH_NAME"
fi

# ============================================================================
# 2. Check commit messages have Linear issue IDs
# ============================================================================
echo ""
echo "2ï¸âƒ£  Checking commit messages for Linear issue IDs..."

# Determine base branch for comparison
# If upstream exists, use it; otherwise compare against origin/main or main
UPSTREAM=$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo "")

if [ -n "$UPSTREAM" ]; then
  # Branch has upstream - compare against it
  BASE_REF="$UPSTREAM"
else
  # New branch without upstream - compare against origin/main or main
  if git rev-parse --verify origin/main >/dev/null 2>&1; then
    BASE_REF="origin/main"
  else
    BASE_REF="main"
  fi
  echo "   â„¹ï¸  No upstream set, comparing against $BASE_REF"
fi

# Get commits that would be pushed
COMMITS=$(git log "$BASE_REF"..HEAD --format=%s 2>/dev/null || echo "")

if [ -z "$COMMITS" ]; then
  echo "   â„¹ï¸  No new commits to push"
else
  # Check if all commits have Linear issue ID (KOM-###)
  INVALID_COMMITS=$(echo "$COMMITS" | grep -vE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|revert)\(KOM-[0-9]+\):" || true)
  
  if [ -n "$INVALID_COMMITS" ]; then
    echo "   âŒ Some commits missing Linear issue ID:"
    echo "$INVALID_COMMITS" | head -5
    echo ""
    echo "   Required format: <type>(KOM-###): <subject>"
    echo "   Example: feat(KOM-123): add customer validation"
    echo ""
    echo "   Fix with:"
    echo "     git commit --amend  # to fix last commit"
    echo "     git rebase -i       # to fix older commits"
    echo ""
    exit 1
  fi
  echo "   âœ… All commits have Linear issue IDs"
fi

# ============================================================================
# 3. Check if documentation needs updating
# ============================================================================
echo ""
echo "3ï¸âƒ£  Checking documentation updates..."

# Get changed files (use same BASE_REF as commit check)
CHANGED_FILES=$(git diff --name-only "$BASE_REF"..HEAD 2>/dev/null || echo "")

if [ -n "$CHANGED_FILES" ]; then
  # Check if API changes were made
  API_FILES=$(echo "$CHANGED_FILES" | grep -E "apps/backend/src/.*\.(controller|dto|guard|module)\.ts$" || true)
  
  if [ -n "$API_FILES" ]; then
    # Check if actual new endpoints/DTOs were added (not just type fixes)
    NEW_ENDPOINTS=$(git diff "$BASE_REF"..HEAD -- $API_FILES 2>/dev/null | grep -E "^\+.*@(Get|Post|Put|Patch|Delete)\(\)" | wc -l || echo "0")
    NEW_DTOS=$(git diff "$BASE_REF"..HEAD -- $API_FILES 2>/dev/null | grep -E "^\+.*export (class|interface).*Dto" | wc -l || echo "0")
    
    # Only require docs if new endpoints or DTOs were added
    if [ "$NEW_ENDPOINTS" -gt 0 ] || [ "$NEW_DTOS" -gt 0 ]; then
      # Check if docs were updated
      if ! echo "$CHANGED_FILES" | grep -qE "^docs/(api/|specifications/API)"; then
        echo "   âš ï¸  WARNING: New API endpoints/DTOs detected but no documentation updates"
        echo "   Consider updating:"
        echo "     - docs/api/reference/"
        echo "     - docs/specifications/API_SPECIFICATION.md"
        echo ""
        echo "   If documentation is not needed, you can proceed."
        echo "   Continue? (y/N)"
        # Auto-continue if running non-interactively (e.g., from CI or automated scripts)
        if [ -t 0 ] && [ -t 1 ]; then
          read -r CONTINUE
        else
          CONTINUE="N"
        fi
        if [ "$CONTINUE" != "y" ] && [ "$CONTINUE" != "Y" ]; then
          echo "   âŒ Push aborted. Update documentation and try again."
          exit 1
        fi
      else
        echo "   âœ… Documentation updated with API changes"
      fi
    else
      echo "   âœ… API files changed but only type fixes (no new endpoints/DTOs)"
    fi
  else
    echo "   âœ… No API changes requiring documentation"
  fi
else
  echo "   â„¹ï¸  No file changes to check"
fi

# ============================================================================
# 4. Run unit tests
# ============================================================================
echo ""
echo "4ï¸âƒ£  Running unit tests..."

if [ "${RUN_PRE_PUSH_TESTS:-0}" = "1" ]; then
  # Run fast backend unit tests only (not integration or E2E)
  pnpm --filter @kompass/backend test:unit -- --passWithNoTests

  if [ $? -ne 0 ]; then
    echo "   âŒ Unit tests failed. Push aborted."
    echo ""
    echo "   Fix the failing tests or skip with: git push --no-verify"
    echo "   (Not recommended - all tests should pass)"
    echo ""
    exit 1
  fi

  echo "   âœ… Unit tests passed"
else
  echo "   âš ï¸ Skipping unit tests (set RUN_PRE_PUSH_TESTS=1 to enable)"
fi

# ============================================================================

# ============================================================================
# Summary
# ============================================================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ALL PRE-PUSH CHECKS PASSED"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "   âœ… Branch name valid"
echo "   âœ… Commit messages valid"
echo "   âœ… Documentation check passed"
echo "   âœ… Unit tests passed"
echo ""
echo "   Pushing to $BRANCH_NAME..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
