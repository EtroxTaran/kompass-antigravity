#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” Running pre-push checks..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Get current branch name
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

# ============================================================================
# 1. Check branch naming convention
# ============================================================================
echo ""
echo "1ï¸âƒ£  Checking branch name format..."

# Allow develop, main, and properly formatted feature branches
if [ "$BRANCH_NAME" != "develop" ] && [ "$BRANCH_NAME" != "main" ]; then
  # Check if branch follows naming convention
  if ! echo "$BRANCH_NAME" | grep -qE "^(feature|bugfix|hotfix|refactor|docs|test|chore)/KOM-[0-9]+-[a-z0-9-]+$"; then
    echo "âŒ Branch name does not follow naming convention"
    echo "   Got: $BRANCH_NAME"
    echo ""
    echo "   Required format: <type>/KOM-###-<description>"
    echo "   Examples:"
    echo "     feature/KOM-123-customer-validation"
    echo "     bugfix/KOM-456-invoice-fix"
    echo "     hotfix/KOM-789-security-patch"
    echo ""
    echo "   Or rename your branch:"
    echo "     git branch -m <new-branch-name>"
    echo ""
    exit 1
  fi
  echo "   âœ… Branch name is valid: $BRANCH_NAME"
else
  echo "   âœ… Main branch: $BRANCH_NAME"
fi

# ============================================================================
# 2. Check commit messages have Linear issue IDs
# ============================================================================
echo ""
echo "2ï¸âƒ£  Checking commit messages for Linear issue IDs..."

# Detect first push (no upstream yet) to avoid failing on @{u}
if ! git rev-parse --abbrev-ref @{u} >/dev/null 2>&1; then
  echo "   â„¹ï¸  No upstream found for this branch yet - skipping commit message check on first push"
else
  # Get commits that would be pushed
  COMMITS=$(git log @{u}.. --format=%s 2>/dev/null)

  if [ -z "$COMMITS" ]; then
    echo "   â„¹ï¸  No new commits to push"
  else
    # Check if all commits have Linear issue ID (KOM-###)
    INVALID_COMMITS=$(echo "$COMMITS" | grep -vE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|revert)\(KOM-[0-9]+\):" || true)
    
    if [ -n "$INVALID_COMMITS" ]; then
      echo "   âŒ Some commits missing Linear issue ID:"
      echo "$INVALID_COMMITS" | head -5
      echo ""
      echo "   Required format: <type>(KOM-###): <subject>"
      echo "   Example: feat(KOM-123): add customer validation"
      echo ""
      echo "   Fix with:"
      echo "     git commit --amend  # to fix last commit"
      echo "     git rebase -i       # to fix older commits"
      echo ""
      exit 1
    fi
    echo "   âœ… All commits have Linear issue IDs"
  fi
fi

# ============================================================================
# 3. Check if documentation needs updating (non-blocking warning only)
# ============================================================================
echo ""
echo "3ï¸âƒ£  Checking documentation updates..."
echo "3ï¸âƒ£  Checking documentation updates..."

# Skip documentation diff check on first push (no upstream)
if ! git rev-parse --abbrev-ref @{u} >/dev/null 2>&1; then
  echo "   â„¹ï¸  No upstream found for this branch yet - skipping documentation update check on first push"
else
  # Get changed files compared to upstream
  CHANGED_FILES=$(git diff --name-only @{u}.. 2>/dev/null)

  if [ -n "$CHANGED_FILES" ]; then
    # Check if API changes were made
    if echo "$CHANGED_FILES" | grep -qE "apps/backend/src/.*\.(controller|dto|guard|module)\.ts$"; then
      # Check if docs were updated
      if ! echo "$CHANGED_FILES" | grep -qE "^docs/(api/|specifications/API)"; then
        echo "   âš ï¸  INFO: API changes detected but no documentation updates found"
        echo "   Consider updating (non-blocking):"
        echo "     - docs/api/reference/"
        echo "     - docs/specifications/API_SPECIFICATION.md"
        echo "   (Push will continue regardless)"
      else
        echo "   âœ… Documentation updated with API changes"
      fi
    else
      echo "   âœ… No API changes requiring documentation"
    fi
  else
    echo "   â„¹ï¸  No file changes to check"
  fi
fi

# ============================================================================
# 4. Run lint, type-check, and tests (same as CI)
# ============================================================================
echo ""
echo "4ï¸âƒ£  Running lint (full monorepo)..."

pnpm lint

if [ $? -ne 0 ]; then
  echo ""
  echo "   âŒ Lint failed. Push aborted."
  echo "   Fix lint errors or skip with: git push --no-verify"
  echo ""
  exit 1
fi

echo "   âœ… Lint passed"

echo ""
echo "5ï¸âƒ£  Running type-check..."

pnpm type-check

if [ $? -ne 0 ]; then
  echo ""
  echo "   âŒ Type-check failed. Push aborted."
  echo "   Fix type errors or skip with: git push --no-verify"
  echo ""
  exit 1
fi

echo "   âœ… Type-check passed"

echo ""
echo "6ï¸âƒ£  Running tests (backend & frontend)..."

# Run backend tests (fast/unit-style) and frontend tests, mirroring CI focus.
pnpm --filter @kompass/backend test -- --passWithNoTests
BACKEND_STATUS=$?

pnpm --filter @kompass/frontend test -- --passWithNoTests
FRONTEND_STATUS=$?

if [ $BACKEND_STATUS -ne 0 ] || [ $FRONTEND_STATUS -ne 0 ]; then
  echo ""
  echo "   âŒ Tests failed. Push aborted."
  echo "   Fix failing tests or skip with: git push --no-verify"
  echo ""
  exit 1
fi

echo "   âœ… Tests passed (backend & frontend)"

# ============================================================================

# ============================================================================
# Summary
# ============================================================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ALL PRE-PUSH CHECKS PASSED"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "   âœ… Branch name valid"
echo "   âœ… Commit messages valid"
echo "   â„¹ï¸  Documentation check completed (non-blocking)"
echo "   âœ… Lint passed"
echo "   âœ… Type-check passed"
echo "   âœ… Tests passed (backend & frontend)"
echo ""
echo "   Pushing to $BRANCH_NAME..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
