#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” Running pre-push checks..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Get current branch name
BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

# ============================================================================
# 1. Check branch naming convention
# ============================================================================
echo ""
echo "1ï¸âƒ£  Checking branch name format..."

# Allow develop, main, and properly formatted feature branches
if [ "$BRANCH_NAME" != "develop" ] && [ "$BRANCH_NAME" != "main" ]; then
  # Check if branch follows naming convention
  if ! echo "$BRANCH_NAME" | grep -qE "^(feature|bugfix|hotfix|refactor|docs|test|chore)/KOM-[0-9]+-[a-z0-9-]+$"; then
    echo "âŒ Branch name does not follow naming convention"
    echo "   Got: $BRANCH_NAME"
    echo ""
    echo "   Required format: <type>/KOM-###-<description>"
    echo "   Examples:"
    echo "     feature/KOM-123-customer-validation"
    echo "     bugfix/KOM-456-invoice-fix"
    echo "     hotfix/KOM-789-security-patch"
    echo ""
    echo "   Or rename your branch:"
    echo "     git branch -m <new-branch-name>"
    echo ""
    exit 1
  fi
  echo "   âœ… Branch name is valid: $BRANCH_NAME"
else
  echo "   âœ… Main branch: $BRANCH_NAME"
fi

# ============================================================================
# 2. Check commit messages have Linear issue IDs
# ============================================================================
echo ""
echo "2ï¸âƒ£  Checking commit messages for Linear issue IDs..."

# Get commits that would be pushed
COMMITS=$(git log @{u}.. --format=%s 2>/dev/null)

if [ -z "$COMMITS" ]; then
  echo "   â„¹ï¸  No new commits to push"
else
  # Check if all commits have Linear issue ID (KOM-###)
  INVALID_COMMITS=$(echo "$COMMITS" | grep -vE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|revert)\(KOM-[0-9]+\):" || true)
  
  if [ -n "$INVALID_COMMITS" ]; then
    echo "   âŒ Some commits missing Linear issue ID:"
    echo "$INVALID_COMMITS" | head -5
    echo ""
    echo "   Required format: <type>(KOM-###): <subject>"
    echo "   Example: feat(KOM-123): add customer validation"
    echo ""
    echo "   Fix with:"
    echo "     git commit --amend  # to fix last commit"
    echo "     git rebase -i       # to fix older commits"
    echo ""
    exit 1
  fi
  echo "   âœ… All commits have Linear issue IDs"
fi

# ============================================================================
# 3. Check if documentation needs updating (non-blocking warning only)
# ============================================================================
echo ""
echo "3ï¸âƒ£  Checking documentation updates..."

# Get changed files
CHANGED_FILES=$(git diff --name-only @{u}.. 2>/dev/null)

if [ -n "$CHANGED_FILES" ]; then
  # Check if API changes were made
  if echo "$CHANGED_FILES" | grep -qE "apps/backend/src/.*\.(controller|dto|guard|module)\.ts$"; then
    # Check if docs were updated
    if ! echo "$CHANGED_FILES" | grep -qE "^docs/(api/|specifications/API)"; then
      echo "   âš ï¸  INFO: API changes detected but no documentation updates found"
      echo "   Consider updating (non-blocking):"
      echo "     - docs/api/reference/"
      echo "     - docs/specifications/API_SPECIFICATION.md"
      echo "   (Push will continue regardless)"
    else
      echo "   âœ… Documentation updated with API changes"
    fi
  else
    echo "   âœ… No API changes requiring documentation"
  fi
else
  echo "   â„¹ï¸  No file changes to check"
fi

# ============================================================================
# 4. Run unit tests
# ============================================================================
echo ""
echo "4ï¸âƒ£  Running unit tests..."

if [ "${RUN_PRE_PUSH_TESTS:-0}" = "1" ]; then
  # Run fast backend unit tests only (not integration or E2E)
  pnpm --filter @kompass/backend test:unit -- --passWithNoTests

  if [ $? -ne 0 ]; then
    echo "   âŒ Unit tests failed. Push aborted."
    echo ""
    echo "   Fix the failing tests or skip with: git push --no-verify"
    echo "   (Not recommended - all tests should pass)"
    echo ""
    exit 1
  fi

  echo "   âœ… Unit tests passed"
else
  echo "   âš ï¸ Skipping unit tests (set RUN_PRE_PUSH_TESTS=1 to enable)"
fi

# ============================================================================

# ============================================================================
# Summary
# ============================================================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ALL PRE-PUSH CHECKS PASSED"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "   âœ… Branch name valid"
echo "   âœ… Commit messages valid"
echo "   â„¹ï¸  Documentation check completed (non-blocking)"
echo "   âœ… Unit tests passed"
echo ""
echo "   Pushing to $BRANCH_NAME..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
