#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” Running pre-commit checks..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ============================================================================
# 1. Check root directory organization
# ============================================================================
echo ""
echo "1ï¸âƒ£  Checking root directory organization..."

# Check if any documentation files are being added to root
STAGED_ROOT_FILES=$(git diff --cached --name-only --diff-filter=A | grep -E "^[^/]+\.md$" | grep -vE "^(README|CHANGELOG|LICENSE|CONTRIBUTING)\.md$" || true)

if [ -n "$STAGED_ROOT_FILES" ]; then
    echo "   âŒ Forbidden documentation files in root directory:"
    echo "$STAGED_ROOT_FILES" | while read file; do
        echo "      - $file"
    done
    echo ""
    echo "   ğŸ“‹ RULE: Only these .md files allowed in root:"
    echo "      - README.md"
    echo "      - CHANGELOG.md"
    echo "      - LICENSE"
    echo "      - CONTRIBUTING.md"
    echo ""
    echo "   ğŸ“ Move documentation to docs/ subdirectories:"
    echo "      - Implementation reports â†’ docs/implementation/"
    echo "      - Deployment docs â†’ docs/deployment/"
    echo "      - Developer guides â†’ docs/guides/"
    echo "      - API docs â†’ docs/api/"
    echo ""
    exit 1
fi

echo "   âœ… No forbidden files in root directory"

# ============================================================================
# 2. Check for forbidden file patterns (backup, old, etc.)
# ============================================================================
echo ""
echo "2ï¸âƒ£  Checking for forbidden file patterns..."

FORBIDDEN_PATTERNS=$(git diff --cached --name-only | grep -E "(_backup|\.backup|\.bak|_old|\.old|_v[0-9]|\.v[0-9]|_fixed|\.fixed|_copy|\.copy|_temp|\.temp|~$|\.swp$|\.tmp$)" || true)

if [ -n "$FORBIDDEN_PATTERNS" ]; then
    echo "   âŒ Forbidden file patterns detected:"
    echo "$FORBIDDEN_PATTERNS" | while read file; do
        echo "      - $file"
    done
    echo ""
    echo "   ğŸ“‹ RULE: Use Git for versioning, not file copies"
    echo "      âŒ NEVER create: *_backup*, *.old, *_v2*, etc."
    echo "      âœ… INSTEAD use: git commit, git branch, git tag"
    echo ""
    echo "   See: .cursor/rules/git-workflow.mdc"
    echo ""
    exit 1
fi

echo "   âœ… No forbidden file patterns found"

# ============================================================================
# 3. Run lint-staged (linting, formatting, type checking)
# ============================================================================
echo ""
echo "3ï¸âƒ£  Running lint-staged checks..."

pnpm lint-staged

if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ Lint-staged checks failed"
    exit 1
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ALL PRE-COMMIT CHECKS PASSED"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
