#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” Running pre-commit checks..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ============================================================================
# 1. Check root directory organization
# ============================================================================
echo ""
echo "1ï¸âƒ£  Checking root directory organization..."

# Check if any documentation files are being added to root
STAGED_ROOT_FILES=$(git diff --cached --name-only --diff-filter=A | grep -E "^[^/]+\.md$" | grep -vE "^(README|CHANGELOG|LICENSE|CONTRIBUTING)\.md$" || true)

if [ -n "$STAGED_ROOT_FILES" ]; then
    echo "   âŒ Forbidden documentation files in root directory:"
    echo "$STAGED_ROOT_FILES" | while read file; do
        echo "      - $file"
    done
    echo ""
    echo "   ğŸ“‹ RULE: Only these .md files allowed in root:"
    echo "      - README.md"
    echo "      - CHANGELOG.md"
    echo "      - LICENSE"
    echo "      - CONTRIBUTING.md"
    echo ""
    echo "   ğŸ“ Move documentation to docs/ subdirectories:"
    echo "      - Implementation reports â†’ docs/implementation/"
    echo "      - Deployment docs â†’ docs/deployment/"
    echo "      - Developer guides â†’ docs/guides/"
    echo "      - API docs â†’ docs/api/"
    echo ""
    exit 1
fi

echo "   âœ… No forbidden files in root directory"

# ============================================================================
# 2. Check for forbidden file patterns (backup, old, etc.)
# ============================================================================
echo ""
echo "2ï¸âƒ£  Checking for forbidden file patterns..."

FORBIDDEN_PATTERNS=$(git diff --cached --name-only | grep -E "(_backup|\.backup|\.bak|_old|\.old|_v[0-9]|\.v[0-9]|_fixed|\.fixed|_copy|\.copy|_temp|\.temp$|~$|\.swp$|\.tmp$)" | grep -vE "\.template$" || true)

if [ -n "$FORBIDDEN_PATTERNS" ]; then
    echo "   âŒ Forbidden file patterns detected:"
    echo "$FORBIDDEN_PATTERNS" | while read file; do
        echo "      - $file"
    done
    echo ""
    echo "   ğŸ“‹ RULE: Use Git for versioning, not file copies"
    echo "      âŒ NEVER create: *_backup*, *.old, *_v2*, etc."
    echo "      âœ… INSTEAD use: git commit, git branch, git tag"
    echo ""
    echo "   See: .cursor/rules/git-workflow.mdc"
    echo ""
    exit 1
fi

echo "   âœ… No forbidden file patterns found"

# ============================================================================
# 3. Check for temporary documentation files
# ============================================================================
echo ""
echo "3ï¸âƒ£  Checking for temporary documentation files..."

# Temporary file patterns (from .cursor/rules/temporary-files-prevention.mdc)
TEMP_PATTERNS=$(git diff --cached --name-only | grep -E "(LINEAR_ISSUE|LINEAR_ISSUES|linear-issue|AUDIT|AUDIT_FINDINGS|FINDINGS|PLANNING_PROMPT|PLANNING|STATUS_|_STATUS_|BUG_FIX|BUG_FIX_SUMMARY|SEARCH_RESULTS|RESULTS|ANALYSIS|ANALYZ|DESIGN_DOCUMENTS|DESIGN|IMPLEMENTATION_NOTES|NOTES|CLEANUP|_CLEANUP|validation-report|FINAL_DELIVERABLES)" | grep -E "\.md$" || true)

# Exceptions (permanent files that match patterns)
EXCEPTIONS="IMPLEMENTATION_SUMMARY|INTEGRATION_SUMMARY|IMPLEMENTATION_COMPLETE|IMPLEMENTATION_GUIDE|INTEGRATION_GUIDE|ROADMAP|STRATEGY|SPECIFICATION|SPEC|ARCHITECTURE|ui-ux/00-updates/FIGMA-UPDATE|ui-ux/00-updates/MIGRATION-"

# Filter out exceptions
TEMP_FILES=$(echo "$TEMP_PATTERNS" | grep -vE "$EXCEPTIONS" || true)

if [ -n "$TEMP_FILES" ]; then
    echo "   âŒ Temporary documentation files detected:"
    echo "$TEMP_FILES" | while read file; do
        echo "      - $file"
    done
    echo ""
    echo "   ğŸ“‹ RULE: Temporary files MUST be in /tmp and deleted after use"
    echo "      âŒ NEVER commit: search results, planning prompts, audit findings,"
    echo "         status reports, bug fix summaries, design notes, cleanup files"
    echo ""
    echo "   âœ… CORRECT:"
    echo "      - Create temporary files in /tmp directory"
    echo "      - Delete temporary files after use"
    echo "      - Put permanent documentation in appropriate docs/ subfolders"
    echo ""
    echo "   ğŸ“ Temporary files should be:"
    echo "      - Linear issue search results â†’ /tmp (then delete)"
    echo "      - Planning prompts â†’ /tmp (then delete)"
    echo "      - Audit findings â†’ Linear issues (not markdown files)"
    echo "      - Status reports â†’ /tmp (then delete)"
    echo "      - Bug fix summaries â†’ git commits and Linear issues"
    echo "      - Design notes â†’ ADRs (docs/architecture/decisions/) or Linear"
    echo ""
    echo "   See: .cursor/rules/temporary-files-prevention.mdc"
    echo ""
    exit 1
fi

echo "   âœ… No temporary documentation files found"

# ============================================================================
# 4. Build shared package first (ensures dist files exist)
# Only build if shared package changed
# ============================================================================
echo ""
echo "4ï¸âƒ£  Checking if shared package changed..."

# Check if shared package changed
if git diff --cached --name-only | grep -q "packages/shared"; then
    echo "   ğŸ“¦ Shared package changed - building..."
    pnpm --filter @kompass/shared build

    if [ $? -ne 0 ]; then
        echo ""
        echo "âŒ Shared package build failed"
        exit 1
    fi

    echo "   âœ… Shared package built successfully"
else
    echo "   â­ï¸  Skipping shared package build (no changes)"
fi

# ============================================================================
# 5. Run lint-staged (linting, formatting)
# ============================================================================
echo ""
echo "5ï¸âƒ£  Running lint-staged checks..."

pnpm lint-staged

if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ Lint-staged checks failed"
    exit 1
fi

echo "   âœ… Lint-staged checks passed"

# ============================================================================
# 6. Run Prettier format check (read-only, matches CI)
# ============================================================================
echo ""
echo "6ï¸âƒ£  Running Prettier format check (read-only)..."

pnpm format:check

if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ Format check failed. Files need formatting."
    echo "   Run 'pnpm format' to auto-fix formatting issues."
    echo ""
    exit 1
fi

echo "   âœ… Format check passed"

# ============================================================================
# 7. Run TypeScript type-check (matches CI)
# ============================================================================
echo ""
echo "7ï¸âƒ£  Running TypeScript type-check..."

pnpm type-check

if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ Type-check failed"
    exit 1
fi

echo "   âœ… Type-check passed"

# ============================================================================
# 8. Optional: Test warning (non-blocking)
# ============================================================================
echo ""
echo "8ï¸âƒ£  Running unit tests (non-blocking warning)..."
echo "   â„¹ï¸  Note: Tests are optional in pre-commit but required in pre-push"

# Run tests but don't block commit if they fail
if pnpm test:unit > /dev/null 2>&1; then
    echo "   âœ… Unit tests passed"
else
    echo ""
    echo "   âš ï¸  WARNING: Unit tests failed or had errors"
    echo "   This is a non-blocking warning. Commit will proceed."
    echo ""
    echo "   ğŸ’¡ Recommendation:"
    echo "      - Fix failing tests before pushing"
    echo "      - Pre-push hook will block if tests fail"
    echo "      - Run 'pnpm test:unit' to see test output"
    echo "      - Or use './scripts/verify-code.sh' for full verification"
    echo ""
fi

# ============================================================================
# 9. Check branch naming (same as CI)
# ============================================================================
echo ""
echo "9ï¸âƒ£  Checking branch naming..."

BRANCH_NAME=$(git branch --show-current)

# Skip validation for main/master branches (protected branches)
if [ "$BRANCH_NAME" = "main" ] || [ "$BRANCH_NAME" = "master" ]; then
    echo "   âœ… Skipping branch name validation for protected branch: $BRANCH_NAME"
else
    if ! echo "$BRANCH_NAME" | grep -qE '^(feature|bugfix|hotfix|refactor|docs|test|chore)/KOM-[0-9]+-[a-z0-9-]+$'; then
        echo "   âŒ Branch name does not follow the required format:"
        echo "      Got: $BRANCH_NAME"
        echo "      Required: <type>/KOM-###-short-description"
        echo ""
        echo "   Examples:"
        echo "      âœ… feature/KOM-123-customer-duplicate-detection"
        echo "      âœ… bugfix/KOM-456-invoice-total-calculation"
        echo "      âŒ feature/customer-feature (missing Linear ID)"
        exit 1
    fi
    echo "   âœ… Branch name follows required format"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ALL PRE-COMMIT CHECKS PASSED"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
