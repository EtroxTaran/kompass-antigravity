version: '3.8'

# KOMPASS Docker Compose - Production Environment
# Override for production-specific configuration

services:
  couchdb:
    environment:
      - COUCHDB_USER=${PRODUCTION_COUCHDB_USER}
      - COUCHDB_PASSWORD=${PRODUCTION_COUCHDB_PASSWORD}
    volumes:
      - /opt/kompass/production/data/couchdb:/opt/couchdb/data
      - /opt/kompass/production/config/couchdb:/opt/couchdb/etc/local.d
      - /opt/kompass/production/backups/couchdb:/opt/couchdb/backups
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  meilisearch:
    environment:
      - MEILI_MASTER_KEY=${PRODUCTION_MEILI_MASTER_KEY}
      - MEILI_ENV=production
    volumes:
      - /opt/kompass/production/data/meilisearch:/meili_data
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  keycloak:
    environment:
      - KEYCLOAK_ADMIN=${PRODUCTION_KEYCLOAK_ADMIN}
      - KEYCLOAK_ADMIN_PASSWORD=${PRODUCTION_KEYCLOAK_ADMIN_PASSWORD}
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://${PRODUCTION_POSTGRES_HOST}:5432/keycloak
      - KC_DB_USERNAME=${PRODUCTION_POSTGRES_USER}
      - KC_DB_PASSWORD=${PRODUCTION_POSTGRES_PASSWORD}
      - KC_HOSTNAME=${PRODUCTION_HOSTNAME}
      - KC_HOSTNAME_STRICT=true
      - KC_HOSTNAME_STRICT_HTTPS=true
      - KC_PROXY=edge
      - KC_LOG_LEVEL=info
    command:
      - start
      - --optimized
      - --http-enabled=false
      - --https-certificate-file=/opt/keycloak/conf/tls.crt
      - --https-certificate-key-file=/opt/keycloak/conf/tls.key
    volumes:
      - /opt/kompass/production/certs:/opt/keycloak/conf
      - /opt/kompass/production/data/keycloak:/opt/keycloak/data
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  neo4j:
    environment:
      - NEO4J_AUTH=${PRODUCTION_NEO4J_AUTH}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_memory_heap_initial__size=2g
      - NEO4J_dbms_memory_heap_max__size=4g
      - NEO4J_dbms_memory_pagecache_size=2g
    volumes:
      - /opt/kompass/production/data/neo4j:/data
      - /opt/kompass/production/logs/neo4j:/logs
      - /opt/kompass/production/backups/neo4j:/backups
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 6G
        reservations:
          cpus: '1'
          memory: 3G

  whisper:
    environment:
      - ASR_MODEL=${PRODUCTION_WHISPER_MODEL:-large-v3}
      - ASR_ENGINE=faster_whisper
    volumes:
      - /opt/kompass/production/data/whisper:/root/.cache/whisper
    restart: always
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

  n8n:
    environment:
      - N8N_BASIC_AUTH_ACTIVE=${PRODUCTION_N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${PRODUCTION_N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${PRODUCTION_N8N_BASIC_AUTH_PASSWORD}
      - N8N_HOST=${PRODUCTION_N8N_HOST:-n8n.kompass.de}
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=${PRODUCTION_N8N_WEBHOOK_URL:-https://n8n.kompass.de}
      - GENERIC_TIMEZONE=Europe/Berlin
      - TZ=Europe/Berlin
    volumes:
      - /opt/kompass/production/data/n8n:/home/node/.n8n
      - /opt/kompass/production/backups/n8n:/backups
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  backend:
    image: ghcr.io/${GITHUB_REPOSITORY}/backend:${IMAGE_TAG:-latest}
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_URL=${PRODUCTION_DATABASE_URL}
      - COUCHDB_USER=${PRODUCTION_COUCHDB_USER}
      - COUCHDB_PASSWORD=${PRODUCTION_COUCHDB_PASSWORD}
      - COUCHDB_DATABASE=kompass
      - MEILISEARCH_URL=${PRODUCTION_MEILISEARCH_URL}
      - MEILISEARCH_MASTER_KEY=${PRODUCTION_MEILI_MASTER_KEY}
      - KEYCLOAK_URL=${PRODUCTION_KEYCLOAK_URL}
      - KEYCLOAK_REALM=kompass
      - KEYCLOAK_CLIENT_ID=kompass-api
      - KEYCLOAK_CLIENT_SECRET=${PRODUCTION_KEYCLOAK_CLIENT_SECRET}
      - JWT_SECRET=${PRODUCTION_JWT_SECRET}
      - ALLOWED_ORIGINS=${PRODUCTION_ALLOWED_ORIGINS}
      - LOG_LEVEL=warn
      # Neo4j connection
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${PRODUCTION_NEO4J_PASSWORD}
      # Whisper API
      - WHISPER_API_URL=${PRODUCTION_WHISPER_API_URL:-http://whisper:9000}
      # n8n webhook URL
      - N8N_WEBHOOK_URL=${PRODUCTION_N8N_WEBHOOK_URL:-https://n8n.kompass.de}
      # Feature flags (injected from GitHub Secrets)
      - AI_N8N_ENABLED=${PRODUCTION_AI_N8N_ENABLED:-false}
      - AI_RAG_ENABLED=${PRODUCTION_AI_RAG_ENABLED:-false}
      - AI_ML_ENABLED=${PRODUCTION_AI_ML_ENABLED:-false}
      - AI_PROXY_URL=${PRODUCTION_AI_PROXY_URL:-http://ai-proxy:8081/api/ai}
      - AI_PROVIDER=${PRODUCTION_AI_PROVIDER:-openai}
      - AI_PROVIDER_API_KEY=${PRODUCTION_AI_PROVIDER_API_KEY:-changeme}
      - AI_PROVIDER_URL=${PRODUCTION_AI_PROVIDER_URL:-https://api.openai.com/v1}
      - AI_CORRELATION_HEADER=${PRODUCTION_AI_CORRELATION_HEADER:-X-Correlation-Id}
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    logging:
      driver: 'json-file'
      options:
        max-size: '50m'
        max-file: '5'

  frontend:
    image: ghcr.io/${GITHUB_REPOSITORY}/frontend:${IMAGE_TAG:-latest}
    environment:
      - VITE_API_URL=${PRODUCTION_API_URL}
      # Feature flags (for frontend feature toggles)
      - VITE_AI_N8N_ENABLED=${PRODUCTION_AI_N8N_ENABLED:-false}
      - VITE_AI_RAG_ENABLED=${PRODUCTION_AI_RAG_ENABLED:-false}
      - VITE_AI_ML_ENABLED=${PRODUCTION_AI_ML_ENABLED:-false}
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: 'json-file'
      options:
        max-size: '50m'
        max-file: '5'

  ai-proxy:
    image: ghcr.io/${GITHUB_REPOSITORY}/ai-proxy:${IMAGE_TAG:-latest}
    environment:
      - NODE_ENV=production
      - PORT=8081
      - AI_PROVIDER=${PRODUCTION_AI_PROVIDER:-openai}
      - AI_PROVIDER_API_KEY=${PRODUCTION_AI_PROVIDER_API_KEY:-changeme}
      - AI_PROVIDER_URL=${PRODUCTION_AI_PROVIDER_URL:-https://api.openai.com/v1}
      - AI_CORRELATION_HEADER=${PRODUCTION_AI_CORRELATION_HEADER:-X-Correlation-Id}
    restart: always
    networks:
      - kompass-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 512M

  gateway:
    image: nginx:1.25-alpine
    ports:
      - '3001:8080'
    volumes:
      - ./infra/gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend
      - ai-proxy
    networks:
      - kompass-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # Nginx Reverse Proxy (optional - for SSL termination)
  nginx-proxy:
    image: nginx:1.25-alpine
    container_name: kompass-nginx-proxy
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - /opt/kompass/production/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - /opt/kompass/production/certs:/etc/nginx/certs:ro
      - /opt/kompass/production/logs/nginx:/var/log/nginx
    depends_on:
      - backend
      - frontend
    networks:
      - kompass-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

networks:
  kompass-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

volumes:
  couchdb-data:
    driver: local
  couchdb-config:
    driver: local
  meilisearch-data:
    driver: local
  keycloak-data:
    driver: local
  neo4j-data:
    driver: local
  neo4j-logs:
    driver: local
  whisper-models:
    driver: local
  n8n-data:
    driver: local
