# Architecture Documentation Critical Review & Pre-Mortem

## Findings (gaps, contradictions, and non-robust areas)
- **Offline storage plan is underspecified for real-world data sizes.** The document budgets exactly 50 MB across three tiers but does not describe eviction triggers, quota enforcement on different browsers, or what happens when essential data alone exceeds the budget (e.g., large attachments or dense customer histories).【F:docs/architecture/system-architecture.md†L104-L120】
- **Compliance posture conflicts with AI routing and fallback.** The AI proxy automatically falls back to OpenAI when self-hosted providers fail, yet the same document promises GDPR-compliant processing and on-prem data control. The missing residency/consent controls for the fallback path make the claim of built-in privacy controls questionable.【F:docs/architecture/system-architecture.md†L58-L68】【F:docs/architecture/system-architecture.md†L385-L392】
- **Risk section overstates certainty.** Multiple technical and operational risks are labeled “Solved” without residual risk, mitigations, or owners, leaving no guidance for monitoring or contingency actions if assumptions fail.【F:docs/architecture/system-architecture.md†L615-L628】
- **RBAC documentation is not actionable given observed access issues.** The system architecture asserts universal guard coverage, but the API spec already documents a rollback scenario for PLAN users losing access, suggesting role semantics and permission propagation are brittle and under-specified in the architecture doc.【F:docs/architecture/system-architecture.md†L441-L469】【F:docs/specifications/api-specification.md†L1039-L1058】
- **Performance/scale targets ignore offline sync load and future concurrency.** Targets cover only online API latency while claiming current capacity of 20–50 concurrent users; there is no sizing for sync spikes, background conflict resolution, or expected growth from Phase 2+ workloads (AI queues, vector DB).【F:docs/architecture/system-architecture.md†L521-L542】
- **Operational coverage omits new components.** Backup/monitoring tables omit Weaviate, BullMQ/Redis, and GPU workloads defined in the AI guide, so recovery points and alerting for those services are undefined.【F:docs/architecture/system-architecture.md†L557-L580】【F:docs/architecture/ai-extensions/AI_Automation_Extensions_Implementation_Guide.md†L36-L115】
- **Resource requirements for AI are unrealistic for MVP environments.** The AI guide calls for 32 GB (dev) to 128 GB (prod) RAM and NVIDIA GPUs without mapping to deployment topology or budget in the main architecture plan, risking under-provisioned pilots.【F:docs/architecture/ai-extensions/AI_Automation_Extensions_Implementation_Guide.md†L36-L45】
- **Data governance paths are abstract.** Audit logging shows a TypeScript interface and blockchain-style chaining but lacks key management, retention enforcement steps, or reconciliation between PouchDB replicas and the immutable audit store, so integrity across offline edits is not verifiable from the docs.【F:docs/architecture/system-architecture.md†L406-L429】
- **Supplier quality and access problems indicate missing feedback loops.** The API includes rollback reasons for access and quality issues, but the architecture doc does not define how production incidents feed into architecture updates or configuration audits.【F:docs/specifications/api-specification.md†L1039-L1058】【F:docs/specifications/api-specification.md†L5565-L5588】

## Pre-mortem scenarios (most plausible failure modes)
- **Data loss or corruption during sync surge.** A regional outage forces many field users to resync simultaneously; without documented quota handling and conflict escalation, replication overwhelms CouchDB, causing missed writes and inconsistent audit chains. The missing offline eviction and audit reconciliation guidance contributes to the failure.【F:docs/architecture/system-architecture.md†L104-L120】【F:docs/architecture/system-architecture.md†L406-L429】
- **Compliance breach via AI fallback.** An unplanned AI provider outage triggers automatic fallback to OpenAI, sending sensitive data to a cloud region without recorded consent or data-processing agreements. The architecture’s privacy claims lacked controls or approvals around fallback routing, enabling the breach.【F:docs/architecture/system-architecture.md†L58-L68】【F:docs/architecture/system-architecture.md†L385-L392】
- **Role regression in production.** A permission matrix rollout silently removes PLAN access, requiring rollback. The architecture does not define regression testing, migration sequencing, or observability for RBAC changes, so the issue is detected only after user complaints and disrupts operations.【F:docs/specifications/api-specification.md†L1039-L1058】【F:docs/architecture/system-architecture.md†L441-L469】
- **Capacity collapse during AI feature launch.** Phase 2 deploys Weaviate and GPU inference on the same hosts sized for 20–50 users; CPU/memory exhaustion causes cascading failures across CouchDB and the backend because capacity planning and isolation for new services were never documented.【F:docs/architecture/system-architecture.md†L521-L542】【F:docs/architecture/ai-extensions/AI_Automation_Extensions_Implementation_Guide.md†L36-L115】
- **Incomplete disaster recovery.** A storage failure wipes the vector index and Redis queue; backups only cover CouchDB and user files, so AI workflows cannot resume and data reconstructions are impossible. Missing backup/restore runbooks for new services extend downtime.【F:docs/architecture/system-architecture.md†L557-L580】【F:docs/architecture/ai-extensions/AI_Automation_Extensions_Implementation_Guide.md†L36-L115】

## Optimization plan for architecture documentation
- **Clarify offline-first constraints and recovery.** Add browser-specific quota expectations, eviction/back-pressure rules, and conflict escalation flows for PouchDB/CouchDB, including how audit logs reconcile after offline edits.【F:docs/architecture/system-architecture.md†L104-L120】【F:docs/architecture/system-architecture.md†L406-L429】
- **Document compliant AI routing.** Extend the AI proxy section with data-classification rules, allowed providers per classification, consent tracking, and explicit opt-out paths before any cloud fallback occurs.【F:docs/architecture/system-architecture.md†L58-L68】【F:docs/architecture/system-architecture.md†L385-L392】
- **Make RBAC guidance testable.** Include migration playbooks, pre/post-deploy RBAC regression tests, and telemetry signals (role change audits, authorization error rates) to prevent repeats of PLAN access regressions.【F:docs/architecture/system-architecture.md†L441-L469】【F:docs/specifications/api-specification.md†L1039-L1058】
- **Update operations coverage for new services.** Add backup/restore, observability, and SLOs for Weaviate, Redis/BullMQ, GPU inference services, and n8n; specify isolation/placement and capacity assumptions for Phase 2+.【F:docs/architecture/system-architecture.md†L521-L580】【F:docs/architecture/ai-extensions/AI_Automation_Extensions_Implementation_Guide.md†L36-L115】
- **Replace "Solved" risk claims with mitigations and owners.** Create a risk register with likelihood/impact, detection methods, owners, and contingency actions instead of unchecked “Solved” labels.【F:docs/architecture/system-architecture.md†L615-L628】
- **Align resource/budget planning.** Tie AI hardware requirements to deployment options (on-prem vs. cloud GPU), expected load, and rollout phases; document cost/benefit trade-offs so teams can provision safely.【F:docs/architecture/ai-extensions/AI_Automation_Extensions_Implementation_Guide.md†L36-L45】
- **Close the feedback loop with product issues.** Add a section describing how incidents like access regressions or supplier quality failures drive architecture updates (e.g., ADR triggers, configuration audits, and rollout freezes).【F:docs/specifications/api-specification.md†L1039-L1058】【F:docs/specifications/api-specification.md†L5565-L5588】
