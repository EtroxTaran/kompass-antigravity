# Lexware Integration Strategy

**Document Version:** 1.0  
**Date:** 2025-11-12  
**Status:** Active Roadmap  
**Owner:** Product & Engineering Team  
**Priority:** CRITICAL - Addresses Pre-Mortem Danger #4

---

## Executive Summary

**Why This Integration is Critical:**

The pre-mortem analysis identified the **Lexware integration as a critical single point of failure**. Relegating invoicing and accounting to an external tool while promising a "single source of truth" creates fundamental credibility problems.

**Pre-Mortem Quote:**

> "The manual CSV import/export is not a plan; it is a guarantee of failure. Manual data transfer is a breeding ground for errors, delays, and immense frustration for the BUCH persona. Financial data will be constantly out of sync, and reports generated by KOMPASS will be untrustworthy."

**Our Response:**

We **acknowledge** the Phase 1 CSV approach is **temporary and imperfect**. This document commits to a clear, funded, time-bound path to full automation. We will not defer this problem.

---

## Strategic Context

### Why Lexware (Not Native Accounting)

**Decision Rationale:**

1. **Regulatory Compliance:** Lexware is certified for German tax/accounting regulations (GoBD, DATEV)
2. **Expertise Gap:** Building compliant accounting software requires specialized domain knowledge
3. **Time to Market:** Building native accounting would delay KOMPASS launch by 12-18 months
4. **Cost/Benefit:** Lexware subscription (€50-100/month) vs. development cost (€100k+ for native accounting)
5. **User Trust:** BUCH persona may trust established tool (Lexware) over new platform

**Revisit Decision:** Year 2, after Phase 1-3 success. Evaluate native accounting based on:

- Lexware integration pain points
- User feedback from BUCH persona
- Cost analysis: 5-year Lexware subscription vs. native development
- Competitive advantage: Does native accounting differentiate us?

### Single Source of Truth

**Truth Definition:**

- **KOMPASS = Source of Truth for:**
  - Customer & contact data
  - Opportunities & sales pipeline
  - Offers & contracts (project-related)
  - Project execution & progress
  - Time tracking & expenses
  - Supplier & material management

- **Lexware = Source of Truth for:**
  - Customer invoicing (GoBD-compliant invoice generation)
  - Payment processing & bank reconciliation
  - Financial accounting (double-entry bookkeeping)
  - Tax reporting (UStVA, EÜR, Bilanz)
  - Payroll (if used)

**Integration Goal:** Bidirectional sync ensures both systems have consistent financial data.

---

## Phase 1: Manual CSV Export/Import (Launch - Month 0-3)

### Philosophy

**"Acknowledge the Pain, Provide Tools"**

We accept that manual CSV is frustrating. We **minimize** the pain through:

- Clear documentation
- Automated validation
- Reconciliation tools
- Explicit limitations communicated

### Scope

**What Works:**

- **Contract → Lexware (Export):**
  - BUCH exports signed contracts from KOMPASS to CSV
  - CSV contains: Customer info, contract number, value, dates, payment terms
  - BUCH imports CSV into Lexware as "Auftrag" (order)
  - Manual process, weekly batch

- **Invoice → Lexware (Export):**
  - Invoices are **generated in Lexware** (GoBD requirement)
  - BUCH manually enters invoice data using KOMPASS contract reference
  - Invoice PDF stored in Lexware, reference stored in KOMPASS (manual link)

- **Payment Status → KOMPASS (Import):**
  - BUCH exports payment report from Lexware (CSV)
  - BUCH imports CSV into KOMPASS (updates invoice payment status)
  - Manual process, weekly batch

**What Doesn't Work:**

- ❌ Real-time sync: Financial data is 1-7 days stale
- ❌ Customer data sync: Must be entered in both systems
- ❌ Automatic reconciliation: Manual checking required
- ❌ Conflict resolution: Manual override needed
- ❌ Audit trail: Integration steps not automatically logged

### CSV Format Specification

**Contract Export (KOMPASS → Lexware):**

```csv
ContractNumber,CustomerNumber,CustomerName,ContractValue,ContractDate,StartDate,EndDate,PaymentTerms,ProjectNumber,Description
V-2025-00123,K-00456,Hofladen Müller GmbH,45000.00,2025-01-15,2025-02-01,2025-02-28,30,P-2025-M003,Ladeneinrichtung REWE München
```

**Fields:**

- ContractNumber: KOMPASS contract number (maps to Lexware Auftragsnummer)
- CustomerNumber: KOMPASS customer ID (must pre-exist in Lexware)
- CustomerName: For verification
- ContractValue: Gross amount (€)
- PaymentTerms: Days (Lexware calculates due date)

**Payment Import (Lexware → KOMPASS):**

```csv
InvoiceNumber,CustomerNumber,InvoiceDate,DueDate,GrossAmount,PaymentDate,PaymentAmount,PaymentMethod,Status
R-2024-00456,K-00456,2024-11-15,2024-12-15,63046.00,2024-12-10,63046.00,Überweisung,Paid
```

### Reconciliation Checklist (BUCH Manual Process)

**Weekly Reconciliation (Anna - BUCH persona):**

1. **Export from KOMPASS:**
   - New/updated contracts (last 7 days)
   - Download CSV via "Export → Lexware CSV"

2. **Import to Lexware:**
   - Import CSV as "Aufträge"
   - Lexware validates customer numbers
   - Fix errors: Missing customers, invalid data

3. **Invoice in Lexware:**
   - Generate invoices in Lexware using KOMPASS contract references
   - Add KOMPASS contract number to Lexware invoice notes field

4. **Export from Lexware:**
   - Payment report (last 7 days)
   - Download CSV

5. **Import to KOMPASS:**
   - Upload CSV via "Import → Zahlungen von Lexware"
   - KOMPASS matches invoices by number
   - Fix errors: Invoice number mismatch, amount discrepancy

6. **Verify Reconciliation:**
   - KOMPASS shows reconciliation report:
     - Matched: 45 invoices (green)
     - Unmatched: 2 invoices (amber - manual review)
     - Errors: 1 invoice (red - fix required)
   - BUCH reviews unmatched/errors, resolves manually

**Estimated Time:** 30-60 minutes per week (depends on volume)

### Tools Provided (Phase 1)

**CSV Export Wizard (KOMPASS):**

- Date range selector
- Entity type: Contracts / Invoices / Payments
- Field mapping preview
- Validation before export
- Download CSV button

**CSV Import Wizard (KOMPASS):**

- Upload CSV file
- Field mapping (auto-detect or manual)
- Validation: Format, required fields, referential integrity
- Preview: Shows matches and errors
- Import with error report

**Reconciliation Dashboard (KOMPASS - BUCH only):**

- Shows: Last sync date, matched items, unmatched items, errors
- Lists unmatched items for manual resolution
- Shows integration health status
- Link to: Integration documentation

---

## Phase 2: Semi-Automated Sync (Month 3-6)

### Philosophy

**"90% Automation, 10% Human Review"**

Automate the repetitive, error-prone manual steps while keeping human oversight for exceptions.

### Scope

**File-Based Integration (Lexware API):**

Lexware supports file-based import/export APIs (not REST APIs, but programmatic file handling):

- **KOMPASS writes CSV to shared folder** (nightly scheduled job)
- **Lexware imports CSV automatically** (using Lexware Scheduler or Windows Task Scheduler)
- **Lexware exports payment data to shared folder** (nightly)
- **KOMPASS imports payment data automatically** (polling or scheduled job)

### Architecture

```
┌──────────────┐                  ┌──────────────┐
│   KOMPASS    │                  │   Lexware    │
│              │                  │              │
│  [Backend]   │  CSV Files       │  [Desktop    │
│     │        │  ═════════════>  │   Client]    │
│     │        │  Contracts       │     │        │
│     │        │                  │     │        │
│     │        │  <═════════════  │     │        │
│     │        │  Payments        │     │        │
│              │                  │              │
└──────────────┘                  └──────────────┘
     │                                   │
     └──── Shared Folder (Network) ─────┘
           /mnt/kompass-lexware-sync/
           ├── exports/  (KOMPASS → Lexware)
           └── imports/  (Lexware → KOMPASS)
```

### Implementation

**KOMPASS Sync Service:**

```typescript
// apps/backend/src/modules/integration/lexware-sync.service.ts

@Injectable()
export class LexwareSyncService {
  // Runs nightly at 2:00 AM
  @Cron("0 2 * * *")
  async exportContractsToLexware(): Promise<SyncResult> {
    // 1. Query new/updated contracts (last 24h)
    const contracts =
      await this.contractRepository.findUpdatedSince(yesterday());

    // 2. Transform to Lexware CSV format
    const csv = this.transformToLexwareFormat(contracts);

    // 3. Write to shared folder with timestamp
    const filename = `kompass_contracts_${timestamp()}.csv`;
    await fs.writeFile(`/mnt/kompass-lexware-sync/exports/${filename}`, csv);

    // 4. Log export
    await this.syncLogRepository.create({
      direction: "export",
      entityType: "contract",
      recordCount: contracts.length,
      filename,
      status: "success",
      timestamp: new Date(),
    });

    // 5. Notify BUCH
    await this.notificationService.send({
      recipients: ["BUCH"],
      type: "LexwareExportReady",
      message: `${contracts.length} Verträge für Lexware bereit`,
      link: `/integration/lexware/exports`,
    });

    return { exported: contracts.length, errors: 0 };
  }

  // Runs every 15 minutes during business hours
  @Cron("*/15 8-18 * * 1-5")
  async importPaymentsFromLexware(): Promise<SyncResult> {
    // 1. List files in imports folder
    const files = await fs.readdir("/mnt/kompass-lexware-sync/imports/");
    const unprocessed = files.filter(
      (f) => f.endsWith(".csv") && !this.isProcessed(f),
    );

    if (unprocessed.length === 0) return { imported: 0, errors: 0 };

    // 2. Process each file
    for (const file of unprocessed) {
      const csvContent = await fs.readFile(
        `/mnt/kompass-lexware-sync/imports/${file}`,
      );
      const payments = this.parsePaymentCSV(csvContent);

      // 3. Match and update invoices
      for (const payment of payments) {
        try {
          await this.invoiceService.recordPayment({
            invoiceNumber: payment.InvoiceNumber,
            paymentDate: payment.PaymentDate,
            paymentAmount: payment.PaymentAmount,
            paymentMethod: payment.PaymentMethod,
          });
        } catch (error) {
          // Log but don't fail entire batch
          await this.syncErrorRepository.create({
            file,
            invoiceNumber: payment.InvoiceNumber,
            error: error.message,
          });
        }
      }

      // 4. Mark file as processed (rename with .processed extension)
      await fs.rename(file, `${file}.processed`);
    }

    return { imported: payments.length, errors: syncErrors.length };
  }
}
```

**Lexware Import Automation (Windows Task Scheduler):**

```batch
REM lexware-import.bat (runs on Lexware PC)
REM Scheduled: Nightly at 3:00 AM

@echo off
set IMPORT_FOLDER=\\server\kompass-lexware-sync\exports
set PROCESSED_FOLDER=\\server\kompass-lexware-sync\exports\processed

REM Find unprocessed CSV files
for %%f in (%IMPORT_FOLDER%\kompass_contracts_*.csv) do (
  echo Importing %%f into Lexware...

  REM Call Lexware command-line import (if available)
  REM OR: Use Lexware API (if available)
  REM OR: Manual import with notification

  lexware-import.exe --file="%%f" --type=contract --log="import.log"

  REM Move to processed folder
  move "%%f" "%PROCESSED_FOLDER%\%%~nxf"
)

echo Lexware import completed.
```

### Validation & Error Handling

**Automated Validation (Before Sync):**

- **Customer exists:** Check Lexware customer number exists in both systems
- **Amount matches:** Contract value matches invoice value (±1%)
- **Date validity:** Contract date is valid, not in future
- **No duplicates:** Contract not already in Lexware (check by contract number)

**Error Handling:**

```typescript
interface SyncError {
  id: string;
  syncDirection: "export" | "import";
  entityType: "contract" | "invoice" | "payment";
  entityId: string;
  errorType:
    | "ValidationError"
    | "NotFoundError"
    | "DuplicateError"
    | "AmountMismatchError";
  errorMessage: string;
  retryCount: number;
  resolvedBy?: string;
  resolvedAt?: Date;
  resolution?: string;
}
```

**Error Dashboard (BUCH):**

- Shows all unresolved sync errors
- BUCH can: Review, fix in source system, retry sync, mark as resolved
- Escalate to GF if blocking

### Success Criteria: Phase 2

1. ✅ 90% of contracts sync automatically without errors
2. ✅ Payment status updates within 4 hours (not 7 days)
3. ✅ BUCH weekly reconciliation time reduced to <15 minutes
4. ✅ Sync errors automatically logged and visible on dashboard
5. ✅ Zero data loss incidents

---

## Phase 3: Real-Time Bidirectional Sync (Month 6-12)

### Philosophy

**"Real-Time, Two-Way, Trustworthy"**

Financial data stays synchronized within minutes, not days. Conflicts are detected and resolved automatically where possible.

### Scope

**Webhook-Based Integration:**

Lexware supports webhook notifications (or we poll frequently):

- **Contract Created/Updated in KOMPASS:**
  - Webhook triggers immediately
  - KOMPASS sends contract data to Lexware API
  - Lexware creates/updates "Auftrag"
  - Lexware sends confirmation webhook back
  - KOMPASS logs: Sync timestamp, Lexware ID

- **Invoice Created in Lexware:**
  - Lexware webhook notifies KOMPASS (or KOMPASS polls every 5 minutes)
  - KOMPASS creates invoice reference record
  - Links invoice to KOMPASS contract by contract number
  - BUCH sees invoice appear in KOMPASS automatically

- **Payment Recorded in Lexware:**
  - Lexware webhook notifies KOMPASS immediately
  - KOMPASS updates invoice payment status
  - Project financial reports update automatically

### Architecture

```
┌─────────────────────────────────────────────────────────┐
│                 KOMPASS Backend                         │
│                                                         │
│ ┌────────────────────────────────────────────────────┐ │
│ │  Lexware Integration Service                       │ │
│ │                                                    │ │
│ │  ┌─ Outbound ─────────────┐  ┌─ Inbound ────────┐ │ │
│ │  │ Contract Created/Updated│  │ Invoice Created  │ │ │
│ │  │   ↓                     │  │   ↓              │ │ │
│ │  │ Transform to Lexware    │  │ Parse webhook    │ │ │
│ │  │   ↓                     │  │   ↓              │ │ │
│ │  │ POST /api/v1/contracts  │  │ Find contract    │ │ │
│ │  │   ↓                     │  │   ↓              │ │ │
│ │  │ Log sync (timestamp)    │  │ Create invoice   │ │ │
│ │  └─────────────────────────┘  └──────────────────┘ │ │
│ │                                                    │ │
│ │  Conflict Detection: Compare timestamps, resolve  │ │
│ │  Retry Logic: Exponential backoff (1s, 2s, 4s...) │ │
│ │  Error Queue: Manual review for failures          │ │
│ └────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
                          ↕️ HTTPS (TLS 1.3)
┌─────────────────────────────────────────────────────────┐
│                 Lexware Cloud API                       │
│                (or Lexware Desktop + Bridge)            │
│                                                         │
│  Endpoints:                                             │
│  - POST /contracts                                      │
│  - GET /invoices                                        │
│  - GET /payments                                        │
│  - Webhooks: invoice.created, payment.recorded          │
└─────────────────────────────────────────────────────────┘
```

### Conflict Resolution Strategy

**Scenario 1: Contract Updated in Both Systems**

- **Detection:** Lexware webhook arrives, KOMPASS checks last modified timestamp
- **Resolution:**
  - If KOMPASS modification <5 minutes ago: KOMPASS wins (user just edited)
  - If Lexware modification is more recent: Lexware wins
  - **Always:** Show conflict warning to BUCH, allow manual override
  - **Never:** Silently overwrite without user knowledge

**Scenario 2: Payment Amount Mismatch**

- **Detection:** Lexware reports payment amount differs from invoice amount
- **Resolution:**
  - If partial payment: Update invoice status to 'PartiallyPaid', log remaining balance
  - If overpayment: Flag for BUCH review (possible credit note needed)
  - If underpayment: Flag for BUCH review (payment plan or dispute)

**Scenario 3: Invoice Number Collision**

- **Detection:** Lexware invoice number already exists in KOMPASS
- **Resolution:**
  - Check: Is this the same invoice (match by customer, amount, date)?
  - If same: Deduplicate, link to existing
  - If different: Error, require BUCH intervention (duplicate invoice number is GoBD violation)

### Success Criteria: Phase 3

1. ✅ Contract sync latency: <5 minutes (contract created in KOMPASS → visible in Lexware)
2. ✅ Payment sync latency: <10 minutes (payment in Lexware → KOMPASS updated)
3. ✅ Sync success rate: 99% (auto-resolution of conflicts)
4. ✅ Manual intervention required: <5% of transactions
5. ✅ BUCH weekly reconciliation time: <5 minutes (verification only)
6. ✅ Zero data inconsistencies reported by users

---

## Phase 4: Native Accounting Evaluation (Year 2+)

### Decision Point

**When to Evaluate:**

- After 18-24 months of Lexware integration
- After Phase 1-3 success and user adoption
- When scale justifies investment (500+ active users, €10M+ annual revenue)

### Evaluation Criteria

**Build Native Accounting if:**

| Criterion                       | Threshold                                  |
| ------------------------------- | ------------------------------------------ |
| Lexware integration pain points | >20% of BUCH time spent on sync issues     |
| User satisfaction (BUCH)        | <3/5 stars on Lexware integration          |
| Cost analysis                   | Native development pays back in <3 years   |
| Competitive advantage           | 30%+ of prospects demand native accounting |
| Regulatory compliance           | We can certify GoBD compliance internally  |

**Keep Lexware if:**

- Integration works smoothly (<5% BUCH time on sync)
- Users are satisfied (≥4/5 stars)
- No competitive pressure for native accounting
- Cost/benefit doesn't justify investment

### Native Accounting Scope (if built)

**Minimum Viable Accounting Module:**

- GoBD-compliant invoicing (immutable, hashed, audit trail)
- Payment tracking and reconciliation
- Basic financial reports (P&L, balance sheet)
- Tax reports (UStVA, EÜR)
- DATEV export interface
- Bank statement import

**Out of Scope (Lexware retains):**

- Payroll
- Asset accounting
- Multi-currency (Phase 1 is EUR-only)
- Advanced financial consolidation

**Estimated Effort:** 12-18 months, 2-3 FTE (backend + accounting domain expert)

---

## Technical Implementation Details

### Phase 1: CSV Generation

**TypeScript Code:**

```typescript
// apps/backend/src/modules/integration/lexware/csv-export.service.ts

@Injectable()
export class LexwareCSVExportService {
  async exportContracts(startDate: Date, endDate: Date): Promise<string> {
    const contracts = await this.contractRepository.findByDateRange(
      startDate,
      endDate,
    );

    const csvRows = contracts.map((contract) => ({
      ContractNumber: contract.contractNumber,
      CustomerNumber: contract.customer.customerNumber, // Must exist in Lexware
      CustomerName: contract.customer.companyName,
      ContractValue: contract.contractValue.toFixed(2),
      ContractDate: this.formatDate(contract.contractDate),
      StartDate: this.formatDate(contract.startDate),
      EndDate: this.formatDate(contract.endDate),
      PaymentTerms: contract.paymentTerms.daysUntilDue.toString(),
      ProjectNumber: contract.projectId,
      Description: this.sanitizeCSV(contract.description),
    }));

    return this.generateCSV(csvRows);
  }

  private formatDate(date: Date): string {
    // Lexware expects: DD.MM.YYYY
    return date.toLocaleDateString("de-DE");
  }

  private sanitizeCSV(text: string): string {
    // Escape quotes, commas, newlines for CSV safety
    return text.replace(/"/g, '""').replace(/\n/g, " ");
  }
}
```

### Phase 2: Automated File Sync

**Scheduled Job Configuration:**

```typescript
// apps/backend/src/modules/integration/lexware/lexware-sync.module.ts

@Module({
  imports: [ScheduleModule.forRoot()],
  providers: [
    LexwareSyncService,
    LexwareCSVExportService,
    LexwareCSVImportService,
  ],
})
export class LexwareSyncModule {}

// Sync schedule:
// - Export contracts: Nightly at 2:00 AM
// - Import payments: Every hour during business hours (8 AM - 6 PM)
// - Error notifications: Immediately on failure
```

### Phase 3: Webhook Handling

**Webhook Receiver:**

```typescript
// apps/backend/src/modules/integration/lexware/lexware-webhook.controller.ts

@Controller("webhooks/lexware")
export class LexwareWebhookController {
  @Post("invoice-created")
  async handleInvoiceCreated(
    @Body() webhook: LexwareInvoiceWebhook,
  ): Promise<void> {
    // 1. Verify webhook signature (security)
    this.verifyWebhookSignature(webhook);

    // 2. Extract invoice data
    const invoiceData = webhook.data;

    // 3. Find matching contract in KOMPASS
    const contract = await this.contractRepository.findByNumber(
      invoiceData.contractReference,
    );

    if (!contract) {
      throw new NotFoundException("Contract not found in KOMPASS");
    }

    // 4. Create invoice reference in KOMPASS
    await this.invoiceService.createFromLexware({
      invoiceNumber: invoiceData.invoiceNumber,
      contractId: contract.id,
      projectId: contract.projectId,
      customerId: contract.customerId,
      grossAmount: invoiceData.amount,
      invoiceDate: invoiceData.date,
      dueDate: invoiceData.dueDate,
      lexwareId: invoiceData.id,
      pdfUrl: invoiceData.pdfUrl,
    });

    // 5. Notify BUCH
    await this.notificationService.send({
      recipients: ["BUCH"],
      type: "InvoiceCreatedInLexware",
      message: `Rechnung ${invoiceData.invoiceNumber} in Lexware erstellt`,
      link: `/invoices/${invoiceData.invoiceNumber}`,
    });
  }

  @Post("payment-recorded")
  async handlePaymentRecorded(
    @Body() webhook: LexwarePaymentWebhook,
  ): Promise<void> {
    // Similar logic for payment recording
    // Updates invoice payment status in KOMPASS real-time
  }
}
```

---

## Error Recovery & Reconciliation

### Sync Error Types

**Type 1: Validation Errors**

- Issue: CSV data fails Lexware validation (invalid customer number, malformed date)
- Detection: Lexware import rejects row
- Resolution: BUCH fixes source data in KOMPASS, re-export

**Type 2: Not Found Errors**

- Issue: Customer exists in KOMPASS but not in Lexware
- Detection: Customer number lookup fails
- Resolution: BUCH creates customer in Lexware first, then retry sync

**Type 3: Amount Mismatch Errors**

- Issue: Invoice amount in Lexware differs from contract value in KOMPASS
- Detection: Automated comparison check
- Resolution: BUCH investigates: Partial invoice, change order, or data entry error

**Type 4: Duplicate Errors**

- Issue: Contract number already exists in target system
- Detection: Unique constraint violation
- Resolution: BUCH checks: Same contract (skip) or duplicate number (rename)

### Reconciliation Tools

**Daily Reconciliation Report (Auto-Generated):**

```
═══════════════════════════════════════════════════════════
KOMPASS ↔ Lexware Synchronisations-Bericht
Datum: 12.11.2025 • Zeitraum: Letzte 24 Stunden
═══════════════════════════════════════════════════════════

Verträge (KOMPASS → Lexware):
  ✓ Exportiert: 5 Verträge
  ✓ Erfolgreich: 4 Verträge
  ⚠️ Fehler: 1 Vertrag
     - V-2025-00156: Kunde nicht in Lexware gefunden

Rechnungen (Lexware → KOMPASS):
  ✓ Importiert: 12 Rechnungen
  ✓ Zugeordnet: 11 Rechnungen
  ⚠️ Nicht zugeordnet: 1 Rechnung
     - R-2025-00789: Vertragsreferenz fehlt

Zahlungen (Lexware → KOMPASS):
  ✓ Importiert: 18 Zahlungen
  ✓ Erfolgreich: 18 Zahlungen
  ✓ Fehler: 0

Gesamtstatus: ⚠️ 2 Fehler erfordern manuelle Prüfung

[Fehler anzeigen und beheben]
═══════════════════════════════════════════════════════════
```

**Sent to:** BUCH persona via email + shown on dashboard

---

## Data Mapping Specification

### Customer Data Mapping

| KOMPASS Field             | Lexware Field | Notes                     |
| ------------------------- | ------------- | ------------------------- |
| customerNumber            | Kundennummer  | Must pre-exist in Lexware |
| companyName               | Firma 1       | Max 50 chars              |
| billingAddress.street     | Straße        |                           |
| billingAddress.zipCode    | PLZ           | 5 digits                  |
| billingAddress.city       | Ort           |                           |
| vatNumber                 | USt-IdNr.     | Optional                  |
| email                     | E-Mail        |                           |
| phone                     | Telefon       |                           |
| paymentTerms.daysUntilDue | Zahlungsziel  | Days                      |

**Preprocessing:**

- Truncate company name to 50 chars if longer
- Validate ZIP code is 5 digits
- Format phone number to Lexware standard

### Contract Data Mapping

| KOMPASS Field   | Lexware Field   | Notes                       |
| --------------- | --------------- | --------------------------- |
| contractNumber  | Auftragsnummer  | Unique                      |
| contractValue   | Auftragswert    | Gross amount (€)            |
| contractDate    | Auftragsdatum   | DD.MM.YYYY                  |
| startDate       | Leistungsbeginn | DD.MM.YYYY                  |
| endDate         | Leistungsende   | DD.MM.YYYY                  |
| projectNumber   | Projekt-ID      | Custom field                |
| description     | Beschreibung    | Max 1000 chars              |
| paymentSchedule | Zahlungsplan    | Multiple payment milestones |

### Invoice Data Mapping

| Lexware Field    | KOMPASS Field  | Notes          |
| ---------------- | -------------- | -------------- |
| Rechnungsnummer  | invoiceNumber  | Primary key    |
| Kundennummer     | customerId     | Lookup         |
| Auftragsnummer   | contractNumber | Lookup         |
| Rechnungsdatum   | invoiceDate    |                |
| Fälligkeitsdatum | dueDate        |                |
| Nettobetrag      | netAmount      |                |
| Bruttobetrag     | grossAmount    |                |
| Bezahlt am       | paymentDate    | Null if unpaid |
| Bezahlter Betrag | paymentAmount  |                |

---

## Security & Compliance

### Data Security

**In Transit:**

- All CSV files encrypted (AES-256) when writing to shared folder
- Shared folder: Restricted permissions (KOMPASS service account + Lexware PC only)
- Network: VPN or encrypted SMB connection
- Webhooks: HTTPS with TLS 1.3

**At Rest:**

- Shared folder: Encrypted filesystem (BitLocker or LUKS)
- Sync logs: Sensitive data redacted (customer names hashed)
- Error logs: Retain for 90 days, then purge

### GoBD Compliance

**Immutability Preservation:**

- Invoices generated in Lexware (GoBD-certified)
- KOMPASS stores invoice **reference** only, not invoice content
- Invoice PDFs served from Lexware (source of truth)
- KOMPASS audit trail logs: When invoice was synced, by whom

**Audit Trail:**

- Every sync operation logged with timestamp, user, success/failure
- Sync logs immutable (append-only)
- Sync logs retained for 10 years (GoBD requirement)

### DSGVO Compliance

**Data Minimization:**

- Only sync financial data (contracts, invoices, payments)
- Customer personal data: Synced only if necessary for invoicing
- No marketing data synced to Lexware

**Data Subject Rights:**

- Customer deletion: Must be coordinated between KOMPASS and Lexware
- Data export: BUCH must export from both systems and merge

---

## Rollout & Training

### Phase 1 Rollout (Week 1)

**Day 1-2: Setup**

- Document: CSV format specification
- Document: Step-by-step reconciliation guide
- Create: CSV export/import wizards in KOMPASS
- Create: Reconciliation dashboard

**Day 3: Training (BUCH)**

- Workshop: "Lexware Integration Workflow" (90 minutes)
- Practice: Export contracts, import payments
- Q&A: Common issues, troubleshooting

**Week 1-4: Support**

- Daily check-ins with BUCH persona (Anna)
- Monitor: Sync errors, reconciliation time
- Fix: Issues discovered during first month

### Phase 2 Rollout (Month 3)

**Week 1: Development**

- Implement: Automated file sync service
- Implement: Error logging and notifications
- Test: Integration with test Lexware instance

**Week 2: Deployment**

- Deploy: File sync service to production
- Configure: Shared folder with encryption
- Configure: Scheduled jobs (nightly export, hourly import)

**Week 3-4: Transition**

- BUCH monitors automated sync
- BUCH intervenes only for errors
- Measure: Time savings, error rate

### Phase 3 Rollout (Month 6-9)

**Month 6: API Integration Development**

- Implement: Webhook receivers
- Implement: Real-time sync logic
- Implement: Conflict resolution rules
- Test: End-to-end with test Lexware instance

**Month 7: Pilot**

- Enable for 1-2 projects only
- BUCH monitors closely
- Collect feedback: Speed, reliability, conflicts

**Month 8: Full Rollout**

- Enable for all projects
- Deprecate Phase 1 CSV process
- Decommission Phase 2 file sync
- Celebrate: Real-time financial integration achieved!

---

## Monitoring & Alerts

### Sync Health Dashboard (BUCH + GF)

**Metrics:**

```
┌────────────────────────────────────────────────────────┐
│ Lexware-Integration Gesundheit                    ✓   │
├────────────────────────────────────────────────────────┤
│                                                        │
│ Phase: 2 (Semi-Automated)                              │
│ Letzter Export: Vor 8 Stunden (2:00 AM)               │
│ Letzter Import: Vor 12 Minuten (11:48 AM)             │
│                                                        │
│ Heute:                                                 │
│ ✓ Verträge exportiert: 5 (Fehler: 0)                  │
│ ✓ Zahlungen importiert: 12 (Fehler: 0)                │
│                                                        │
│ Diese Woche:                                           │
│ ✓ Gesamt: 45 Transaktionen synchronisiert             │
│ ⚠️ Fehler: 2 (manuell behoben)                        │
│ ⏱️ Durchschn. Zeit: 3,2 Stunden (Ziel: <4h)          │
│                                                        │
│ [Fehlerprotokoll anzeigen] [Nächste Synchronisation]  │
└────────────────────────────────────────────────────────┘
```

**Alerts:**

- **Error rate >5%:** Email to BUCH + GF
- **Sync failed:** Immediate Slack notification
- **Data inconsistency detected:** Create incident ticket

---

## User Expectations & Communication

### Phase 1 User Communication

**Message to BUCH Persona (Week 1):**

> **Lexware-Integration: Phase 1 (Manueller CSV-Export)**
>
> Für die ersten 3 Monate verwenden wir CSV-Export/Import zwischen KOMPASS und Lexware. Wir wissen, dass dies nicht ideal ist.
>
> **Was funktioniert:**
>
> - Vertragsexport von KOMPASS nach Lexware (wöchentlich)
> - Zahlungsimport von Lexware nach KOMPASS (wöchentlich)
> - Automatische Validierung und Fehlerprüfung
> - Reconciliation-Dashboard zur Überwachung
>
> **Was nicht funktioniert:**
>
> - Echtzeit-Synchronisation (Daten sind 1-7 Tage alt)
> - Automatische Kundenanlage
> - Konfliktauflösung (manuell erforderlich)
>
> **Zeitaufwand:** Ca. 30-60 Minuten pro Woche
>
> **Was kommt als Nächstes:**
>
> - **Monat 3:** Semi-automatische Synchronisation (90% automatisiert)
> - **Monat 6:** Echtzeit-Synchronisation (99% automatisiert)
>
> Ihr Feedback ist entscheidend. Bitte melden Sie alle Probleme sofort.

### Phase 2/3 Migration Communication

**Message to BUCH Persona (Before Upgrade):**

> **Lexware-Integration Upgrade: Phase 2 → Semi-Automatisch**
>
> Ab nächster Woche läuft die Synchronisation automatisch.
>
> **Was sich ändert:**
>
> - Keine manuellen CSV-Exports mehr
> - Zahlungen werden alle 4 Stunden synchronisiert (statt wöchentlich)
> - Fehler werden automatisch gemeldet
> - Ihr Zeitaufwand: <15 Minuten pro Woche (nur Fehlerprüfung)
>
> **Was gleich bleibt:**
>
> - Sie behalten die Kontrolle
> - Sie können Synchronisation pausieren
> - Sie prüfen und genehmigen alle Finanztransaktionen
>
> **Training:** 30-Minuten Session am Montag, 10:00 Uhr

---

## Success Metrics

### Phase 1 Success

- [ ] BUCH can complete weekly reconciliation in <60 minutes
- [ ] Zero data loss incidents
- [ ] <10% sync error rate
- [ ] 100% of errors documented and resolved
- [ ] BUCH satisfaction: ≥3/5 stars ("It works, but tedious")

### Phase 2 Success

- [ ] BUCH weekly reconciliation time: <15 minutes
- [ ] Sync error rate: <5%
- [ ] Payment status latency: <4 hours
- [ ] 90% of syncs require no manual intervention
- [ ] BUCH satisfaction: ≥4/5 stars ("Much better, mostly automated")

### Phase 3 Success

- [ ] Real-time sync latency: <10 minutes
- [ ] Sync success rate: 99%
- [ ] Manual intervention: <5% of transactions
- [ ] BUCH weekly reconciliation: <5 minutes (verification only)
- [ ] Zero reports of financial data inconsistencies
- [ ] BUCH satisfaction: 5/5 stars ("Seamless, trustworthy")

---

## Risk Mitigation

### Addressing Pre-Mortem Concern

**Pre-Mortem Danger #4:** "The manual Lexware integration is a notorious failure point for data integrity and operational efficiency."

**Our Mitigation:**

1. ✅ **Transparent about limitations:** Phase 1 is temporary, not permanent
2. ✅ **Funded roadmap:** Phase 2 and 3 have committed timelines and resources
3. ✅ **Reduced manual effort:** Provide tools (validation, reconciliation dashboard)
4. ✅ **User-centric:** Minimize BUCH persona pain, solicit feedback
5. ✅ **Fast iteration:** 3-month cycles, not 12-month delays
6. ✅ **Kill switch:** If Phase 2 fails, commit to Phase 4 (native accounting) by Year 2

### Integration Failure Scenarios

**Scenario: Lexware API Unavailable**

- **Phase 2/3 Fallback:** Automatic fallback to CSV export/import (Phase 1 mode)
- **User Notification:** "Lexware-Verbindung unterbrochen. Verwende manuellen Modus."
- **Recovery:** Retry API connection every 15 minutes
- **Data Safety:** All transactions queued, no data loss

**Scenario: Data Corruption During Sync**

- **Detection:** Checksums and validation on every sync
- **Response:** Halt sync, alert BUCH + GF immediately
- **Recovery:** Restore from last known good state (backup)
- **Post-Mortem:** Investigate root cause, patch vulnerability

---

## Related Documents

- [Pre-Mortem Analysis](../reviews/PROJECT_KOMPASS_PRE-MORTEM_ANALYSIS.md) - Risk identification (Danger #4)
- [Financial Data Flow](FINANCIAL_DATA_FLOW.md) - Complete financial workflow
- [BUCH Persona](../personas/Persona_BUCH.md) - Primary user affected by integration
- [GoBD Compliance](../reviews/GOBD_COMPLIANCE_STRATEGY.md) - Regulatory requirements

---

## Revision History

| Version | Date       | Author       | Changes                                               |
| ------- | ---------- | ------------ | ----------------------------------------------------- |
| 1.0     | 2025-11-12 | Product Team | Initial 4-phase roadmap addressing pre-mortem concern |
