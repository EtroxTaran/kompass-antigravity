name: CI Quality Gates

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PNPM_VERSION: 8.15.0
  NODE_VERSION: '20'

jobs:
  lint:
    name: ESLint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint

  format-check:
    name: Prettier
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Prettier check
        run: pnpm format:check

  type-check:
    name: TypeScript
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package first
        run: pnpm --filter @kompass/shared build

      - name: Type check all packages
        run: pnpm type-check

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests with coverage thresholds
        run: |
          pnpm --filter @kompass/backend test:cov
          pnpm --filter @kompass/frontend test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: unit-coverage

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest

    services:
      couchdb:
        image: couchdb:3.3
        env:
          COUCHDB_USER: admin
          COUCHDB_PASSWORD: testpassword
        ports:
          - 5984:5984
        options: >-
          --health-cmd "curl -f http://localhost:5984/_up"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      meilisearch:
        image: getmeili/meilisearch:v1.5
        env:
          MEILI_MASTER_KEY: testmasterkey
          MEILI_NO_ANALYTICS: true
        ports:
          - 7700:7700
        options: >-
          --health-cmd "curl -f http://localhost:7700/health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Wait for services
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:5984/_up; do sleep 2; done'
          timeout 60 bash -c 'until curl -f http://localhost:7700/health; do sleep 2; done'

      - name: Build shared package first
        run: pnpm --filter @kompass/shared build

      - name: Run integration tests
        env:
          COUCHDB_URL: http://localhost:5984
          COUCHDB_USER: admin
          COUCHDB_PASSWORD: testpassword
          MEILISEARCH_URL: http://localhost:7700
          MEILISEARCH_MASTER_KEY: testmasterkey
        run: pnpm test:integration

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package first
        run: pnpm --filter @kompass/shared build

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium firefox webkit

      - name: Build frontend
        run: pnpm --filter @kompass/frontend build

      - name: Run E2E tests
        run: pnpm test:e2e

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  build:
    name: Build Verification
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package first
        run: pnpm --filter @kompass/shared build

      - name: Build all workspaces
        run: pnpm build

  documentation:
    name: Documentation Guard
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure docs updated when required
        run: bash .github/scripts/check-docs-update.sh
        env:
          GITHUB_BASE_REF: ${{ github.base_ref || github.ref_name }}

      - name: Validate markdown links (Lychee)
        uses: lycheeverse/lychee-action@v2.0.2
        with:
          # Check all docs markdown files plus the root README
          args: >
            --config .github/lychee.toml
            README.md
            docs/**/*.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Ensure API docs regenerated
        run: pnpm run generate:api-docs

  commit-message-check:
    name: Commit Messages
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate conventional commits with Linear IDs
        run: |
          BASE_BRANCH="${{ github.base_ref || github.ref_name }}"
          git fetch origin "$BASE_BRANCH"
          # Exclude merge commits (they're auto-generated by GitHub)
          COMMITS=$(git log origin/${BASE_BRANCH}..HEAD --format=%s --no-merges)
          echo "Checking commit messages (excluding merge commits)..."
          echo "$COMMITS"

          if [ -z "$COMMITS" ]; then
            echo "✅ No commits to check (only merge commits)"
            exit 0
          fi

          if echo "$COMMITS" | grep -qvE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|revert)\(KOM-[0-9]+\):"; then
            echo "❌ Some commits do not follow the required format:"
            echo "$COMMITS" | grep -vE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|revert)\(KOM-[0-9]+\):"
            echo ""
            echo "Required format: <type>(KOM-###): <subject>"
            exit 1
          fi

          echo "✅ All commit messages follow the required format"

  branch-name-check:
    name: Branch Naming
    runs-on: ubuntu-latest

    steps:
      - name: Validate branch naming convention
        run: |
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"

          # Skip validation for main/master branches (protected branches)
          if [[ "$BRANCH_NAME" == "main" || "$BRANCH_NAME" == "master" ]]; then
            echo "✅ Skipping branch name validation for protected branch: $BRANCH_NAME"
            exit 0
          fi

          if [[ ! "$BRANCH_NAME" =~ ^(feature|bugfix|hotfix|refactor|docs|test|chore)/KOM-[0-9]+-[a-z0-9-]+$ ]]; then
            echo "❌ Branch name does not follow the required format:"
            echo "   Got: $BRANCH_NAME"
            echo "Required: <type>/KOM-###-short-description"
            exit 1
          fi

          echo "✅ Branch name follows required format"

  root-directory-check:
    name: Root Directory Hygiene
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run root directory organization check
        run: bash .github/scripts/check-root-directory.sh

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: pnpm audit (high severity or above)
        run: pnpm audit --audit-level=high

      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/typescript
            p/react
            p/nodejs

  performance-tests:
    name: Performance Regression
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run performance regression suite
        run: pnpm test:performance

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    if: always()
    needs:
      - lint
      - format-check
      - type-check
      - unit-tests
      - integration-tests
      - e2e-tests
      - build
      - documentation
      - commit-message-check
      - branch-name-check
      - root-directory-check
      - security-audit
      - performance-tests

    steps:
      - name: Summarize quality gate
        run: |
          FAILED=""

          if [ "${{ needs.lint.result }}" != "success" ]; then
            FAILED="$FAILED\n  - ESLint"
          fi
          if [ "${{ needs.format-check.result }}" != "success" ]; then
            FAILED="$FAILED\n  - Prettier"
          fi
          if [ "${{ needs.type-check.result }}" != "success" ]; then
            FAILED="$FAILED\n  - TypeScript"
          fi
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            FAILED="$FAILED\n  - Unit tests"
          fi
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            FAILED="$FAILED\n  - Integration tests"
          fi
          if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            FAILED="$FAILED\n  - E2E tests"
          fi
          if [ "${{ needs.build.result }}" != "success" ]; then
            FAILED="$FAILED\n  - Build"
          fi
          if [ "${{ needs.documentation.result }}" != "success" ]; then
            FAILED="$FAILED\n  - Documentation guard"
          fi
          if [ "${{ needs.commit-message-check.result }}" != "success" ]; then
            FAILED="$FAILED\n  - Commit messages"
          fi
          if [ "${{ needs.branch-name-check.result }}" != "success" ]; then
            FAILED="$FAILED\n  - Branch name"
          fi
          if [ "${{ needs.root-directory-check.result }}" != "success" ]; then
            FAILED="$FAILED\n  - Root directory"
          fi
          if [ "${{ needs.security-audit.result }}" != "success" ]; then
            FAILED="$FAILED\n  - Security audit"
          fi
          if [ "${{ needs.performance-tests.result }}" != "success" ]; then
            FAILED="$FAILED\n  - Performance tests"
          fi

          if [ -n "$FAILED" ]; then
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "❌ QUALITY GATE FAILED"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo -e "$FAILED"
            exit 1
          fi

          echo "✅ All quality gates passed"

  docker-images:
    name: Publish Docker Images
    runs-on: ubuntu-latest
    needs:
      - quality-gate
    # Only publish images on successful push to main (trunk-based development)
    if: needs.quality-gate.result == 'success' && github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract backend metadata
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/backend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=main-
            type=raw,value=main

      - name: Build and push backend image
        id: push-backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract frontend metadata
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/frontend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=main-
            type=raw,value=main

      - name: Build and push frontend image
        id: push-frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Publish image digests
        run: |
          cat <<'EOF'
          Backend image digest: ${{ steps.push-backend.outputs.digest }}
          Frontend image digest: ${{ steps.push-frontend.outputs.digest }}
          EOF
