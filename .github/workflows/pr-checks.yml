name: PR Checks (Quality Gates)

on:
  pull_request:
    branches: [main, develop]

jobs:
  # Run all quality checks in parallel
  lint:
    name: ESLint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint

  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check all packages
        run: pnpm type-check

  format-check:
    name: Prettier Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check formatting
        run: pnpm format:check

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests with coverage
        run: pnpm test:unit --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: unit-coverage

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    services:
      couchdb:
        image: couchdb:3.3
        env:
          COUCHDB_USER: admin
          COUCHDB_PASSWORD: testpassword
        ports:
          - 5984:5984
        options: >-
          --health-cmd "curl -f http://localhost:5984/_up"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      meilisearch:
        image: getmeili/meilisearch:v1.5
        env:
          MEILI_MASTER_KEY: testmasterkey
          MEILI_NO_ANALYTICS: true
        ports:
          - 7700:7700
        options: >-
          --health-cmd "curl -f http://localhost:7700/health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Wait for services
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:5984/_up; do sleep 2; done'
          timeout 60 bash -c 'until curl -f http://localhost:7700/health; do sleep 2; done'

      - name: Run integration tests
        env:
          COUCHDB_URL: http://localhost:5984
          COUCHDB_USER: admin
          COUCHDB_PASSWORD: testpassword
          MEILISEARCH_URL: http://localhost:7700
          MEILISEARCH_MASTER_KEY: testmasterkey
        run: pnpm test:integration

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium firefox webkit

      - name: Build frontend
        run: pnpm --filter frontend build

      - name: Run E2E tests
        run: pnpm test:e2e

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Audit dependencies
        run: pnpm audit --audit-level=high

      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/typescript
            p/react
            p/nodejs

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}

      - name: Run documentation update check
        run: bash .github/scripts/check-docs-update.sh
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}

  commit-message-check:
    name: Commit Message Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit messages
        run: |
          # Check all commits in this PR
          COMMITS=$(git log origin/${{ github.base_ref }}..HEAD --format=%s)
          
          echo "Checking commit messages..."
          echo "$COMMITS"
          
          # Check if all commits have Linear issue ID
          if echo "$COMMITS" | grep -qvE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|revert)\(KOM-[0-9]+\):"; then
            echo "âŒ Some commits do not follow the required format:"
            echo "$COMMITS" | grep -vE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|revert)\(KOM-[0-9]+\):"
            echo ""
            echo "Required format: <type>(KOM-###): <subject>"
            echo "Example: feat(KOM-123): add customer validation"
            exit 1
          fi
          
          echo "âœ… All commit messages follow the required format"

  branch-name-check:
    name: Branch Name Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check branch name format
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          
          # Valid patterns: feature/KOM-123-description, bugfix/KOM-456-description, etc.
          if [[ ! "$BRANCH_NAME" =~ ^(feature|bugfix|hotfix|refactor|docs|test|chore)/KOM-[0-9]+-[a-z0-9-]+$ ]]; then
            echo "âŒ Branch name does not follow the required format:"
            echo "   Got: $BRANCH_NAME"
            echo ""
            echo "Required format: <type>/KOM-###-<description>"
            echo "Examples:"
            echo "   feature/KOM-123-customer-duplicate-detection"
            echo "   bugfix/KOM-456-invoice-calculation"
            echo "   hotfix/KOM-789-security-jwt"
            exit 1
          fi
          
          echo "âœ… Branch name follows the required format"

  root-directory-check:
    name: Root Directory Organization Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check root directory for forbidden files
        run: bash .github/scripts/check-root-directory.sh

  pr-quality-gate:
    name: PR Quality Gate
    runs-on: ubuntu-latest
    needs: 
      - lint
      - type-check
      - format-check
      - unit-tests
      - integration-tests
      - e2e-tests
      - build-check
      - security-audit
      - documentation-check
      - commit-message-check
      - branch-name-check
      - root-directory-check
    if: always()
    
    steps:
      - name: Check all jobs passed
        run: |
          echo "Checking quality gate results..."
          
          FAILED_JOBS=""
          
          if [ "${{ needs.lint.result }}" != "success" ]; then
            FAILED_JOBS="$FAILED_JOBS\n  - ESLint"
          fi
          
          if [ "${{ needs.type-check.result }}" != "success" ]; then
            FAILED_JOBS="$FAILED_JOBS\n  - TypeScript Type Check"
          fi
          
          if [ "${{ needs.format-check.result }}" != "success" ]; then
            FAILED_JOBS="$FAILED_JOBS\n  - Prettier Format Check"
          fi
          
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            FAILED_JOBS="$FAILED_JOBS\n  - Unit Tests"
          fi
          
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            FAILED_JOBS="$FAILED_JOBS\n  - Integration Tests"
          fi
          
          if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            FAILED_JOBS="$FAILED_JOBS\n  - E2E Tests"
          fi
          
          if [ "${{ needs.build-check.result }}" != "success" ]; then
            FAILED_JOBS="$FAILED_JOBS\n  - Build Check"
          fi
          
          if [ "${{ needs.security-audit.result }}" != "success" ]; then
            FAILED_JOBS="$FAILED_JOBS\n  - Security Audit"
          fi
          
          if [ "${{ needs.documentation-check.result }}" != "success" ]; then
            FAILED_JOBS="$FAILED_JOBS\n  - Documentation Check"
          fi
          
          if [ "${{ needs.commit-message-check.result }}" != "success" ]; then
            FAILED_JOBS="$FAILED_JOBS\n  - Commit Message Check"
          fi
          
          if [ "${{ needs.branch-name-check.result }}" != "success" ]; then
            FAILED_JOBS="$FAILED_JOBS\n  - Branch Name Check"
          fi
          
          if [ "${{ needs.root-directory-check.result }}" != "success" ]; then
            FAILED_JOBS="$FAILED_JOBS\n  - Root Directory Organization Check"
          fi
          
          if [ -n "$FAILED_JOBS" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ QUALITY GATE FAILED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "The following checks failed:"
            echo -e "$FAILED_JOBS"
            echo ""
            echo "Please fix the issues and push again."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ALL QUALITY GATES PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Linting passed"
          echo "âœ… Type checking passed"
          echo "âœ… Formatting passed"
          echo "âœ… Unit tests passed"
          echo "âœ… Integration tests passed"
          echo "âœ… E2E tests passed"
          echo "âœ… Build succeeded"
          echo "âœ… Security audit passed"
          echo "âœ… Documentation check passed"
          echo "âœ… Commit messages valid"
          echo "âœ… Branch name valid"
          echo "âœ… Root directory clean"
          echo ""
          echo "ğŸ‰ Ready for code review and merge!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

