name: Documentation Checks

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/**/*.ts'
      - 'apps/**/*.tsx'
      - 'packages/**/*.ts'
      - 'docs/**'
      - 'README.md'

jobs:
  check-docs-updated:
    name: Check Documentation Updated
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }}

      - name: Run documentation update check
        run: |
          bash .github/scripts/check-docs-update.sh
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}

  validate-links:
    name: Validate Documentation Links
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for broken links in markdown
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          config-file: '.github/markdown-link-check.json'
          folder-path: 'docs'
          file-path: 'README.md'

  check-api-spec-sync:
    name: Check API Specification Sync
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate API documentation
        run: pnpm run generate:api-docs

      - name: Check if API docs are up to date
        run: |
          if git diff --exit-code docs/api/; then
            echo "✅ API documentation is up to date"
          else
            echo "❌ API documentation is out of sync with code"
            echo "Run 'pnpm run generate:api-docs' and commit the changes"
            git diff docs/api/
            exit 1
          fi

  check-changelog:
    name: Check Changelog Entry
    runs-on: ubuntu-latest
    if: github.base_ref == 'main' || github.base_ref == 'develop'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for CHANGELOG.md update
        run: |
          # Check if CHANGELOG.md was modified
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "CHANGELOG.md"; then
            echo "✅ CHANGELOG.md was updated"
            exit 0
          fi
          
          # Check if this is a trivial change (docs, tests, chore)
          COMMIT_MSGS=$(git log --format=%s origin/${{ github.base_ref }}...HEAD)
          if echo "$COMMIT_MSGS" | grep -qE "^(docs|test|chore|ci|style)\("; then
            echo "ℹ️  Trivial changes (docs/test/chore) - changelog not required"
            exit 0
          fi
          
          # For feat/fix/refactor, changelog should be updated
          if echo "$COMMIT_MSGS" | grep -qE "^(feat|fix|refactor)\("; then
            echo "⚠️  Feature/fix/refactor detected but CHANGELOG.md not updated"
            echo "   Please add an entry to CHANGELOG.md under 'Unreleased' section"
            echo "   Or run: pnpm run changelog:add"
            exit 1
          fi
          
          echo "✅ No changelog entry required for these changes"

  lint-docs:
    name: Lint Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check markdown files
        uses: DavidAnson/markdownlint-cli2-action@v14
        with:
          globs: |
            docs/**/*.md
            README.md
          config: '.markdownlint.json'
          fix: false

  docs-status:
    name: Documentation Status Check
    runs-on: ubuntu-latest
    needs: [check-docs-updated, validate-links, check-api-spec-sync, lint-docs]
    if: always()
    
    steps:
      - name: Check all documentation jobs passed
        run: |
          if [ "${{ needs.check-docs-updated.result }}" != "success" ] || \
             [ "${{ needs.validate-links.result }}" != "success" ] || \
             [ "${{ needs.check-api-spec-sync.result }}" != "success" ] || \
             [ "${{ needs.lint-docs.result }}" != "success" ]; then
            echo "❌ Documentation checks failed"
            exit 1
          fi
          echo "✅ All documentation checks passed"

