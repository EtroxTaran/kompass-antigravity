# KOMPASS Docker Compose - Development Environment
# For staging/production, use docker-compose.staging.yml or docker-compose.production.yml

services:
  # CouchDB - Offline-first database
  couchdb:
    image: couchdb:3.3
    container_name: kompass-couchdb
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD:-devpassword}
    ports:
      - '5984:5984'
    volumes:
      - couchdb-data:/opt/couchdb/data
      - couchdb-config:/opt/couchdb/etc/local.d
    networks:
      - kompass-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5984/_up']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  # MeiliSearch - Search engine
  meilisearch:
    image: getmeili/meilisearch:v1.5
    container_name: kompass-meilisearch
    environment:
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY:-devmasterkey}
      - MEILI_NO_ANALYTICS=true
      - MEILI_ENV=development
    ports:
      - '7700:7700'
    volumes:
      - meilisearch-data:/meili_data
    networks:
      - kompass-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:7700/health']
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # PostgreSQL - Database for Keycloak
  postgres:
    image: postgres:16-alpine
    container_name: kompass-postgres
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=${POSTGRES_USER:-keycloak}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-devpassword}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - kompass-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-keycloak}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # Keycloak - Authentication & SSO
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: kompass-keycloak
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-devpassword}
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://postgres:5432/keycloak
      - KC_DB_USERNAME=${POSTGRES_USER:-keycloak}
      - KC_DB_PASSWORD=${POSTGRES_PASSWORD:-devpassword}
      - KC_HTTP_ENABLED=true
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
      - KC_LOG_LEVEL=info
      - KC_HEALTH_ENABLED=true
    command:
      - start-dev
    ports:
      - '8080:8080'
    volumes:
      - keycloak-data:/opt/keycloak/data
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - kompass-network
    healthcheck:
      # Simple TCP connection test - check if port 8080 is listening
      # This works without requiring curl/wget/pgrep
      test: ['CMD-SHELL', 'timeout 1 bash -c "</dev/tcp/localhost/8080" 2>/dev/null || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s  # Keycloak takes longer to start with PostgreSQL and schema initialization
    restart: unless-stopped

  # Backend - NestJS API
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: development  # Use development stage for hot reload
    container_name: kompass-backend
    environment:
      - NODE_ENV=development
      - PORT=3000
      - CHOKIDAR_USEPOLLING=true  # Enable polling for file watching in Docker
      - DATABASE_URL=http://couchdb:5984
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD:-devpassword}
      - COUCHDB_DATABASE=kompass
      - MEILISEARCH_URL=http://meilisearch:7700
      - MEILISEARCH_MASTER_KEY=${MEILI_MASTER_KEY:-devmasterkey}
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=kompass
      - KEYCLOAK_CLIENT_ID=kompass-api
      - JWT_SECRET=${JWT_SECRET:-dev-jwt-secret-min-32-chars-long}
      - ALLOWED_ORIGINS=http://localhost:3000,http://frontend:8080
      # Neo4j connection
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-devpassword}
      # Whisper API
      - WHISPER_API_URL=http://whisper:9000
      # n8n webhook URL
      - N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL:-http://n8n:5678}
      # Feature flags (runtime, not build-time)
      - AI_N8N_ENABLED=${AI_N8N_ENABLED:-false}
      - AI_RAG_ENABLED=${AI_RAG_ENABLED:-false}
      - AI_ML_ENABLED=${AI_ML_ENABLED:-false}
    ports:
      - '3000:3000'  # Expose on 3000 to match NestJS default
    volumes:
      - ./apps/backend/src:/app/apps/backend/src
      - ./apps/backend/scripts:/app/apps/backend/scripts
      - ./packages/shared/src:/app/packages/shared/src
      - backend-node-modules:/app/apps/backend/node_modules
      - shared-node-modules:/app/packages/shared/node_modules
    # Run in dev mode with watch for hot reload
    # Using dev:fixed which runs watch mode with automatic path fixing
    command: ["pnpm", "--filter", "@kompass/backend", "dev:fixed"]
    depends_on:
      couchdb:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    networks:
      - kompass-network
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s  # More lenient for dev mode (allows for initial build)
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

  # Frontend - React PWA with Vite dev server
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      target: development  # Use development stage for hot reload
      args:
        - VITE_API_URL=http://localhost:3000
    container_name: kompass-frontend
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:3000
      - CHOKIDAR_USEPOLLING=true  # Enable polling for file watching in Docker
    ports:
      - '5173:5173'  # Vite dev server port
    volumes:
      - ./apps/frontend/src:/app/apps/frontend/src
      - ./apps/frontend/public:/app/apps/frontend/public
      - ./packages/shared/src:/app/packages/shared/src
      - frontend-node-modules:/app/apps/frontend/node_modules
      - shared-node-modules:/app/packages/shared/node_modules
    # Run Vite dev server for hot module replacement
    command: ["pnpm", "--filter", "@kompass/frontend", "dev", "--host", "0.0.0.0"]
    depends_on:
      - backend
    networks:
      - kompass-network
    healthcheck:
      test:
        [
          'CMD',
          'curl',
          '-f',
          'http://localhost:5173',
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s  # Allow time for Vite to start
    restart: unless-stopped

  # Neo4j - Graph database for knowledge management
  neo4j:
    image: neo4j:5.26-community
    container_name: kompass-neo4j
    environment:
      - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/devpassword}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
      - NEO4J_dbms_memory_pagecache_size=512m
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
    networks:
      - kompass-network
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--no-verbose',
          '--tries=1',
          '--spider',
          'http://localhost:7474',
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # n8n - Workflow automation
  n8n:
    image: n8nio/n8n:latest
    container_name: kompass-n8n
    environment:
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-devpassword}
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=${N8N_WEBHOOK_URL:-http://localhost:5678}
      - GENERIC_TIMEZONE=Europe/Berlin
      - TZ=Europe/Berlin
    ports:
      - '5678:5678'
    volumes:
      - n8n-data:/home/node/.n8n
    depends_on:
      - backend
    networks:
      - kompass-network
    healthcheck:
      test:
        [
          'CMD',
          'wget',
          '--no-verbose',
          '--tries=1',
          '--spider',
          'http://localhost:5678/healthz',
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # CRM Service - Placeholder for future integration
  # Uncomment when CRM service is ready
  # crm:
  #   image: <crm-image>
  #   container_name: kompass-crm
  #   environment:
  #     - CRM_API_URL=${CRM_API_URL}
  #   ports:
  #     - "8002:8000"
  #   networks:
  #     - kompass-network
  #   restart: unless-stopped

networks:
  kompass-network:
    driver: bridge

volumes:
  couchdb-data:
    driver: local
  couchdb-config:
    driver: local
  meilisearch-data:
    driver: local
  postgres-data:
    driver: local
  keycloak-data:
    driver: local
  neo4j-data:
    driver: local
  neo4j-logs:
    driver: local
  whisper-models:
    driver: local
  n8n-data:
    driver: local
  # Named volumes for node_modules to avoid host/container conflicts
  backend-node-modules:
    driver: local
  frontend-node-modules:
    driver: local
  shared-node-modules:
    driver: local
