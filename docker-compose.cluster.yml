# KOMPASS Docker Compose - CouchDB Cluster Mode
# This override file extends docker-compose.yml with a 3-node CouchDB cluster
# Usage: docker-compose -f docker-compose.yml -f docker-compose.cluster.yml up -d

version: '3.8'

services:
  # Remove single CouchDB instance if cluster is enabled
  couchdb:
    deploy:
      replicas: 0

  # CouchDB Cluster Node 1
  couchdb-node1:
    image: couchdb:3.3
    container_name: kompass-couchdb-node1
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD:-devpassword}
      - NODENAME=couchdb@couchdb-node1
      - ERL_FLAGS=-setcookie ${COUCHDB_COOKIE:-monster}
    ports:
      - '5984:5984'
      - '5986:5986'  # Clustering port
    volumes:
      - couchdb-node1-data:/opt/couchdb/data
      - couchdb-node1-config:/opt/couchdb/etc/local.d
    networks:
      - kompass-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5984/_up']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped
    command:
      - /opt/couchdb/bin/couchdb
      - -setcookie
      - ${COUCHDB_COOKIE:-monster}

  # CouchDB Cluster Node 2
  couchdb-node2:
    image: couchdb:3.3
    container_name: kompass-couchdb-node2
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD:-devpassword}
      - NODENAME=couchdb@couchdb-node2
      - ERL_FLAGS=-setcookie ${COUCHDB_COOKIE:-monster}
    ports:
      - '5985:5984'
      - '5987:5986'  # Clustering port
    volumes:
      - couchdb-node2-data:/opt/couchdb/data
      - couchdb-node2-config:/opt/couchdb/etc/local.d
    networks:
      - kompass-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5984/_up']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped
    command:
      - /opt/couchdb/bin/couchdb
      - -setcookie
      - ${COUCHDB_COOKIE:-monster}
    depends_on:
      - couchdb-node1

  # CouchDB Cluster Node 3
  couchdb-node3:
    image: couchdb:3.3
    container_name: kompass-couchdb-node3
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD:-devpassword}
      - NODENAME=couchdb@couchdb-node3
      - ERL_FLAGS=-setcookie ${COUCHDB_COOKIE:-monster}
    ports:
      - '5988:5984'
      - '5989:5986'  # Clustering port
    volumes:
      - couchdb-node3-data:/opt/couchdb/data
      - couchdb-node3-config:/opt/couchdb/etc/local.d
    networks:
      - kompass-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5984/_up']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped
    command:
      - /opt/couchdb/bin/couchdb
      - -setcookie
      - ${COUCHDB_COOKIE:-monster}
    depends_on:
      - couchdb-node1
      - couchdb-node2

  # Update backend to use cluster node 1 as entry point
  backend:
    environment:
      - DATABASE_URL=http://couchdb-node1:5984
    depends_on:
      couchdb-node1:
        condition: service_healthy

volumes:
  couchdb-node1-data:
    driver: local
  couchdb-node1-config:
    driver: local
  couchdb-node2-data:
    driver: local
  couchdb-node2-config:
    driver: local
  couchdb-node3-data:
    driver: local
  couchdb-node3-config:
    driver: local

