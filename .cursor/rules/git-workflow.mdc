---
description: No file duplication rule, Conventional Commits format, branch naming conventions, PR requirements and template, pre-commit hooks, and branch protection rules
globs: []
alwaysApply: true
---

# Git Workflow & Version Control

## No File Duplication - STRICTLY ENFORCED

### Use Git for Versioning

**NEVER create duplicate copies of files.** Use Git for all versioning needs:

```bash
# ✅ CORRECT: Use git for versions
git commit -m "feat(KOM-123): add customer validation"
# If you need to revert:
git revert HEAD
# If you need to see history:
git log --follow customer.service.ts
# If you need to compare versions:
git diff HEAD~1 customer.service.ts
```

### Forbidden File Patterns

**NEVER create files matching these patterns:**

```bash
# ❌ WRONG: Backup/duplicate patterns
file_backup.ts
file.backup.ts
file_backup_2024.ts
file.bak
file~                    # Editor backup
file.swp                 # Vim swap file
file.tmp                 # Temporary file

# ❌ WRONG: Version suffixes
file_v2.ts
file_v2.0.ts
file_v1.ts
file.version2.ts
file.new.ts
file-v2.ts                   # Hyphen-based versioning
architecture-v1-comprehensive.md  # Documentation versioning
specification-v2-updated.md

# ❌ WRONG: Status suffixes
file_fixed.ts
file.fixed.ts
file_final.ts
file.final.ts
file_working.ts
file.working.ts
file_done.ts
file.done.ts

# ❌ WRONG: Old/temporary suffixes
file_old.ts
file.old.ts
file_old_backup.ts
file_temp.ts
file.temp.ts
file_tmp.ts
file.tmp.ts

# ❌ WRONG: Date-based duplicates
file_2024-01-27.ts
file_20240127.ts
file_jan27.ts

# ❌ WRONG: Copy suffixes
file_copy.ts
file.copy.ts
file_copy2.ts
file_copy_final.ts

# ❌ WRONG: Test/experimental suffixes
file_test.ts              # Use __tests__/ directory instead
file.experimental.ts
file_try.ts
file.try.ts
```

### Complete Pattern List

**These patterns are FORBIDDEN in the entire codebase:**

- `*_backup*`, `*.backup*`, `*.bak`, `*~`, `*.swp`, `*.tmp`
- `*_v[0-9]*`, `*.v[0-9]*`, `*-v[0-9]*`, `*_version*`, `*.version*`
- `*_fixed*`, `*.fixed*`, `*_final*`, `*.final*`, `*_working*`, `*.working*`
- `*_old*`, `*.old*`, `*_temp*`, `*.temp*`, `*_tmp*`, `*.tmp*`
- `*_copy*`, `*.copy*`, `*_copy[0-9]*`
- `*_[0-9]{4}-[0-9]{2}-[0-9]{2}*` (date suffixes)
- `*_test.ts`, `*.test.ts` (use `__tests__/` directory instead)
- `*_experimental*`, `*.experimental*`, `*_try*`, `*.try*`
- `*-comprehensive*`, `*-pragmatic*`, `*-detailed*` (architecture versioning)
- `*_new*`, `*_latest*`, `*_current*` (status-based duplicates)

### Prevent Duplication

**If Cursor suggests creating a duplicate file, ALWAYS respond:**

```
"No, do not create a duplicate file. Instead:
1. Make the changes directly to the existing file
2. Commit the changes to git with a descriptive message
3. If you need to revert: use 'git revert' or 'git checkout'
4. If you need to compare: use 'git diff' or 'git log'
5. If you need experimental code: create a feature branch"
```

### Exception: Archive Directory (Rare Cases Only)

**ONLY** if historical snapshots must be preserved outside Git (extremely rare):

```bash
# ✅ CORRECT: Archive directory (use sparingly)
archive/
├── legacy/
│   └── old-api-spec-v1.yaml    # Only if Git history insufficient
└── README.md                    # Explain why files are archived

# ❌ WRONG: Archive files in project root or source directories
customer.service.ts
customer.service.archived.ts     # NEVER do this
```

**Rules for archive directory:**
- Must have `archive/README.md` explaining why files exist
- Must be reviewed and cleaned quarterly
- Must not contain code files (only documentation/legacy specs)
- Must be excluded from build/test processes

### Git History is Your Version Control

**Use Git commands instead of file copies:**

```bash
# See file history
git log --follow --all -- path/to/file.ts

# See changes in a file
git log -p path/to/file.ts

# Compare with previous version
git diff HEAD~1 path/to/file.ts

# Restore previous version (creates new commit)
git checkout HEAD~1 -- path/to/file.ts
git commit -m "revert(KOM-123): restore previous version"

# Create a branch for experimental changes
git checkout -b experiment/KOM-123-new-approach
# Make changes, test, then merge or discard
```

### Pre-Commit Hook Enforcement

**Pre-commit hooks MUST detect and reject duplicate patterns:**

```bash
# .husky/pre-commit should include:
# Check for forbidden patterns
if git diff --cached --name-only | grep -E '(_backup|\.backup|\.bak|_old|\.old|_v[0-9]|\.v[0-9]|-v[0-9]|_fixed|\.fixed|_copy|\.copy|_temp|\.temp|_comprehensive|_pragmatic|_detailed|_new|_latest|_current|~$|\.swp$|\.tmp$)'; then
  echo "❌ ERROR: Forbidden file pattern detected!"
  echo "Use Git for versioning instead of creating duplicate files."
  echo "Specifically forbidden: version suffixes (-v1, -v2, -comprehensive, -pragmatic, etc.)"
  exit 1
fi
```

## Commit Message Format (Conventional Commits)

### Commit Message Structure

```
<type>(<scope>): <subject>

<body>

<footer>
```

### Types

- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation changes
- `style`: Code style changes (formatting, etc.)
- `refactor`: Code refactoring
- `test`: Test additions/changes
- `chore`: Build process, dependencies, etc.

### ✅ CORRECT: Commit Messages

```bash
# Feature commit
feat(KOM-123): add customer duplicate detection

# Bug fix commit
fix(KOM-456): correct invoice total calculation

# Documentation commit
docs(KOM-234): update OpenAPI spec

# Refactor commit
refactor(KOM-789): extract RBAC logic to guard

# Test commit
test(KOM-567): add status transition tests

# Chore commit
chore(KOM-890): update nestjs to v10
```

### ❌ WRONG: Commit Messages

```bash
# ❌ Vague commit messages
git commit -m "fix stuff"
git commit -m "updates"
git commit -m "wip"

# ❌ Missing Linear issue reference
git commit -m "feat: add customer duplicate detection"

# ❌ Wrong format
git commit -m "feat KOM-123: add feature"
```

## Branch Naming

### Branch Name Format

```
<type>/<linear-issue-id>-<short-description>
```

### ✅ CORRECT: Branch Names

```bash
feature/KOM-123-customer-duplicate-detection
feature/KOM-456-invoice-gobd-compliance
bugfix/KOM-789-opportunity-status-validation
hotfix/KOM-234-security-jwt-expiration
refactor/KOM-567-extract-rbac-logic
docs/KOM-890-update-api-documentation
```

### ❌ WRONG: Branch Names

```bash
# ❌ Missing Linear issue ID
feature/customer-duplicate-detection

# ❌ Wrong format
KOM-123-feature-customer-duplicate

# ❌ Vague description
bugfix/KOM-456-fix

# ❌ No type
KOM-123-customer-feature
```

## Pull Request Rules

### PR Requirements

- EVERY change MUST go through a pull request
- NEVER commit directly to main/master
- PR must have:
  - Descriptive title (following conventional commit format)
  - Description of changes
  - Reference to Linear issue (required)
  - Screenshots/videos for UI changes
  - Test results (all tests passing)
  - At least 1 code review approval (2 for critical changes)

### PR Template

```markdown
## Description

Brief description of changes. References [KOM-123](https://linear.app/kompass/issue/KOM-123).

## Type of Change

- [ ] Bug fix
- [ ] New feature
- [ ] Breaking change
- [ ] Documentation update

## Testing

- [ ] All tests passing
- [ ] New tests added
- [ ] Manual testing completed
- [ ] E2E tests updated (if applicable)

## Screenshots (if applicable)

[Add screenshots here]

## Related Issues

Closes KOM-123
```

## Pre-Commit Hooks

### Required Hooks

Pre-commit hooks MUST run:

1. **Linting**: ESLint checks
2. **Formatting**: Prettier format check
3. **Type Checking**: TypeScript type checking
4. **Unit Tests**: Run affected unit tests
5. **Secrets Check**: Scan for hardcoded secrets

### Husky Configuration

```json
{
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged",
      "commit-msg": "commitlint -E HUSKY_GIT_PARAMS"
    }
  },
  "lint-staged": {
    "*.{ts,tsx}": [
      "eslint --fix",
      "prettier --write",
      "git add"
    ],
    "*.{json,md}": [
      "prettier --write",
      "git add"
    ]
  }
}
```

## Git Workflow

### Standard Workflow

1. **Create Linear issue** → Status: "Todo"
2. **Create branch** → `feature/KOM-123-description`
3. **Make changes** → Write code, add tests
4. **Commit changes** → `feat(KOM-123): description`
5. **Push branch** → `git push origin feature/KOM-123-description`
6. **Create PR** → Link to Linear issue
7. **Update Linear** → Status: "In Review"
8. **Code review** → Get approval
9. **Merge PR** → Linear issue auto-updates to "Done"

### Branch Protection

Main branch MUST have:

- Require pull request reviews
- Require status checks to pass
- Require branches to be up to date
- Require linear issue reference in PR
- Restrict pushes (no direct commits)

## References

- Linear Integration: `.cursor/rules/linear-integration.mdc`
- Conventional Commits: https://www.conventionalcommits.org/
