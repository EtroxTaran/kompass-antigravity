---
description: Code review requirements, review checklist (functionality, security, code quality, testing, documentation), review focus areas, and automated checks
globs: []
alwaysApply: true
---

# Code Review Standards

## Review Requirements

### Mandatory Reviews

- EVERY change MUST go through a pull request
- NEVER commit directly to main/master
- At least 1 code review approval required (2 for security-critical changes)
- All CI checks MUST pass before merging

### Review Checklist

Every code review MUST check:

1. **Functionality**
   - Does the code meet the requirements?
   - Are edge cases handled?
   - Are error cases handled?

2. **Security**
   - No hardcoded secrets
   - Input validation and sanitization
   - RBAC guards on endpoints
   - No sensitive data in logs

3. **Code Quality**
   - Follows project structure rules
   - Uses shadcn/ui components (no custom UI)
   - Proper TypeScript types (no 'any')
   - Functions are < 50 lines
   - No code duplication

4. **Testing**
   - Tests added for new functionality
   - Test coverage maintained or improved
   - Tests follow 70/20/10 pyramid

5. **Documentation**
   - JSDoc comments for complex functions
   - README updated if needed
   - Linear issue referenced

6. **Architecture**
   - No versioned files created (architecture-v2.md, spec-v1.md, etc.)
   - ADR exists for significant architectural changes
   - Single source of truth maintained
   - Architecture document updated if patterns change

## Review Focus Areas

### Security-Critical Areas

Extra scrutiny required for:

- Authentication/authorization code
- Payment/financial operations
- Data export/import
- User input handling
- Database queries
- API endpoints

### Performance-Critical Areas

Check for:

- N+1 query problems
- Missing indexes
- Unnecessary re-renders
- Large bundle sizes
- Memory leaks

## Review Comments

### âœ… CORRECT: Constructive Review Comments

```markdown
**Security Concern:**
The login endpoint doesn't have rate limiting. Consider adding @Throttle(10, 60) to prevent brute force attacks.

**Code Quality:**
This function is 75 lines long. Consider extracting the validation logic into a separate function.

**Testing:**
This change needs tests for the error case when the customer is not found.
```

### âŒ WRONG: Vague or Unhelpful Comments

```markdown
This looks wrong.
Can you fix this?
I don't like this approach.
```

## Automated Checks

### Pre-Merge Requirements

Before merging, ensure:

- [ ] All tests passing
- [ ] Linting passes (ESLint, Prettier)
- [ ] Type checking passes
- [ ] No security vulnerabilities (pnpm audit)
- [ ] Test coverage maintained
- [ ] Linear issue referenced
- [ ] PR description complete

## AI Pre-Commit Verification

### CRITICAL: AI Must Verify Before Suggesting Commits

**AI assistants MUST run verification checks before suggesting ANY commit.**

### Required Verification Checklist

Before suggesting a commit, AI MUST complete this checklist:

- [ ] **Read Configuration Files**
  - [ ] Read `.prettierrc.js` for formatting rules
  - [ ] Read `.eslintrc.js` for linting rules
  - [ ] Read `tsconfig.json` for TypeScript settings

- [ ] **Run Format Check**
  - [ ] Run `pnpm format:check`
  - [ ] Show actual command output (not just "passed")
  - [ ] If failed, run `pnpm format` and show output
  - [ ] Re-run `pnpm format:check` to verify fix

- [ ] **Run Lint Check**
  - [ ] Run `pnpm lint`
  - [ ] Show actual command output (not just "passed")
  - [ ] Fix any linting errors shown in output
  - [ ] Re-run `pnpm lint` to verify fix

- [ ] **Run Type Check**
  - [ ] Run `pnpm type-check`
  - [ ] Show actual command output (not just "passed")
  - [ ] Fix any type errors shown in output
  - [ ] Re-run `pnpm type-check` to verify fix

- [ ] **Run Unit Tests**
  - [ ] Run `pnpm test:unit`
  - [ ] Show actual command output (not just "passed")
  - [ ] Fix any failing tests shown in output
  - [ ] Re-run `pnpm test:unit` to verify fix

- [ ] **Show Verification Results**
  - [ ] Include verification results in commit message suggestion
  - [ ] Show summary of what passed/failed

### Verification Script

Use the verification script for comprehensive checks:

```bash
# Run all checks at once
./scripts/verify-code.sh

# Fast mode (skip tests, for quick checks)
./scripts/verify-code.sh --skip-tests
```

### âœ… CORRECT: AI Pre-Commit Verification

```bash
# 1. Run verification
$ ./scripts/verify-code.sh
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ” Running code verification checks...
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ” Format Check
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Checking formatting...
âœ” All files are properly formatted

ðŸ” Lint Check
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Running ESLint...
âœ” No linting errors found

ðŸ” Type Check
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Type checking...
âœ” Type check passed

ðŸ” Unit Tests
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Running unit tests...
âœ” All tests passed (45/45)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… ALL VERIFICATION CHECKS PASSED
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# 2. Now suggest commit with verification results
git commit -m "feat(KOM-123): add customer duplicate detection

Verification:
- âœ… Format check passed
- âœ… Lint check passed (0 errors)
- âœ… Type check passed
- âœ… Unit tests passed (45/45)"
```

### âŒ WRONG: Skipping Verification

```bash
# âŒ WRONG: Suggesting commit without verification
git commit -m "feat(KOM-123): add customer duplicate detection"
# (No verification shown, no checks run)
```

### âŒ WRONG: Vague Verification

```bash
# âŒ WRONG: Just saying "checks passed" without showing output
"All checks passed. Ready to commit."
# (No actual command outputs shown, can't verify what was checked)
```

### Error Handling

When checks fail:

1. **Show the full error output** (don't truncate)
2. **Explain what the error means**
3. **Fix the issue** using the error message as guidance
4. **Re-run the check** to verify the fix
5. **Show the success output** after fixing

### Example: Format Check Failed

```bash
# Show actual error
$ pnpm format:check
Checking formatting...
âœ— apps/backend/src/modules/customer/customer.service.ts
  Code style issues found

# Fix the formatting
$ pnpm format
Formatted 1 file

# Verify fix
$ pnpm format:check
Checking formatting...
âœ” All files are properly formatted
```

### Example: Lint Check Failed

```bash
# Show actual error
$ pnpm lint
apps/backend/src/modules/customer/customer.service.ts
  15:5  error  'any' type is not allowed  @typescript-eslint/no-explicit-any
  23:10 error  Missing return type        @typescript-eslint/explicit-function-return-type

# Fix the issues
# ... make code changes ...

# Verify fix
$ pnpm lint
âœ” No linting errors found
```

## Review Best Practices

### For Reviewers

- Be constructive and respectful
- Explain why changes are needed
- Suggest specific improvements
- Approve when satisfied
- Request changes when issues found

### For Authors

- Keep PRs small and focused
- Respond to all comments
- Update PR based on feedback
- Don't take feedback personally
- Ask for clarification if needed

## References

- AI Code Verification: `.cursor/rules/ai-code-verification.mdc`
- Verification Script: `scripts/verify-code.sh`
- Git Workflow: `.cursor/rules/git-workflow.mdc`
- Testing Strategy: `.cursor/rules/testing-strategy.mdc`
- Security Best Practices: `.cursor/rules/security-best-practices.mdc`
