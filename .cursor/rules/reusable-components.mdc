---
description: When and what to extract to packages/shared, reusable services and custom hooks patterns, strict no copy-paste code rule
globs: ["**/*.ts", "**/*.tsx"]
alwaysApply: true
---

# Reusable Components & Code Extraction

## When to Extract to packages/shared

Extract code to `packages/shared/` when:

- Used by both backend and frontend
- Pure functions without framework dependencies
- Domain types and interfaces
- Validation rules
- Constants
- Utility functions

### ✅ CORRECT: Shared Code Structure

```
packages/shared/src/
├── types/
│   ├── entities/     # Customer, Opportunity, Project, etc.
│   ├── dtos/         # CreateCustomerDto, UpdateCustomerDto, etc.
│   └── enums/        # Status enums, Role enums, etc.
├── validation/
│   ├── customer.validation.ts   # Shared validation rules
│   └── opportunity.validation.ts
├── constants/
│   ├── rbac.constants.ts        # RBAC roles and permissions
│   └── gobd.constants.ts        # GoBD compliance rules
└── utils/
    ├── id-generator.ts          # UUID and GoBD ID generation
    ├── date-utils.ts            # Date formatting, calculations
    └── validation-utils.ts      # Common validation functions
```

### ❌ WRONG: Framework-Specific Code in Shared

```typescript
// ❌ WRONG: React-specific code in shared
import { useState } from 'react'; // Framework dependency!

// ❌ WRONG: NestJS-specific code in shared
import { Injectable } from '@nestjs/common'; // Framework dependency!

// ✅ CORRECT: Framework-agnostic shared code
export function formatCurrency(value: number): string {
  return new Intl.NumberFormat('de-DE', {
    style: 'currency',
    currency: 'EUR'
  }).format(value);
}
```

## Reusable Services

### Service Composition Pattern

```typescript
// ✅ CORRECT: Reusable service composition
@Injectable()
export class CustomerService {
  constructor(
    private readonly repository: ICustomerRepository,
    private readonly validationService: ValidationService, // Reusable
    private readonly auditService: AuditService,           // Reusable
    private readonly rbacService: RbacService,             // Reusable
  ) {}
  
  async create(dto: CreateCustomerDto, user: User): Promise<Customer> {
    // Use reusable validation service
    await this.validationService.validate(dto, CreateCustomerDto);
    
    // Use reusable RBAC service
    await this.rbacService.checkPermission(user, 'Customer', 'CREATE');
    
    // Business logic
    const customer = this.mapToEntity(dto, user);
    const created = await this.repository.create(customer);
    
    // Use reusable audit service
    await this.auditService.log({
      action: 'CREATE',
      entity: 'Customer',
      entityId: created.id,
      userId: user.id,
    });
    
    return created;
  }
}
```

### ❌ WRONG: Duplicating Service Logic

```typescript
// ❌ WRONG: Duplicated validation logic
@Injectable()
export class CustomerService {
  async create(dto: CreateCustomerDto, user: User): Promise<Customer> {
    // Validation logic duplicated here
    if (!dto.companyName || dto.companyName.length < 2) {
      throw new ValidationException('Invalid company name');
    }
    // ... more validation
  }
}

@Injectable()
export class OpportunityService {
  async create(dto: CreateOpportunityDto, user: User): Promise<Opportunity> {
    // Same validation logic duplicated!
    if (!dto.companyName || dto.companyName.length < 2) {
      throw new ValidationException('Invalid company name');
    }
    // ... more validation
  }
}
```

## Reusable Hooks

### Custom Hook Library Structure

```
apps/frontend/src/hooks/
├── useAuth.ts           # Authentication state
├── useOffline.ts        # Offline status detection
├── useRBAC.ts           # Permission checks
├── useDebounce.ts       # Debounced values
├── useLocalStorage.ts   # Persistent local storage
└── useToast.ts          # Toast notifications
```

### ✅ CORRECT: Reusable Custom Hook

```typescript
// apps/frontend/src/hooks/useDebounce.ts
import { useState, useEffect } from 'react';

export function useDebounce<T>(value: T, delay: number = 500): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value);

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    return () => {
      clearTimeout(handler);
    };
  }, [value, delay]);

  return debouncedValue;
}

// Usage in multiple components
function CustomerSearch() {
  const [searchTerm, setSearchTerm] = useState('');
  const debouncedSearch = useDebounce(searchTerm, 500);
  
  useEffect(() => {
    if (debouncedSearch) {
      searchCustomers(debouncedSearch);
    }
  }, [debouncedSearch]);

  return (
    <Input
      value={searchTerm}
      onChange={(e) => setSearchTerm(e.target.value)}
      placeholder="Search customers..."
    />
  );
}
```

### ❌ WRONG: Duplicating Hook Logic

```typescript
// ❌ WRONG: Duplicated debounce logic in multiple components
function CustomerSearch() {
  const [searchTerm, setSearchTerm] = useState('');
  const [debouncedSearch, setDebouncedSearch] = useState('');

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedSearch(searchTerm);
    }, 500);
    return () => clearTimeout(handler);
  }, [searchTerm]);
  // ... rest of component
}

function OpportunitySearch() {
  const [searchTerm, setSearchTerm] = useState('');
  const [debouncedSearch, setDebouncedSearch] = useState('');

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedSearch(searchTerm);
    }, 500);
    return () => clearTimeout(handler);
  }, [searchTerm]);
  // ... same logic duplicated!
}
```

## No Copy-Paste Code

### ✅ CORRECT: Extract to Shared Utility

```typescript
// packages/shared/src/utils/currency.utils.ts
export function formatCurrency(value: number): string {
  return new Intl.NumberFormat('de-DE', {
    style: 'currency',
    currency: 'EUR'
  }).format(value);
}

// apps/backend/src/modules/invoice/invoice.service.ts
import { formatCurrency } from '@kompass/shared/utils/currency.utils';

// apps/frontend/src/features/invoice/components/InvoiceCard.tsx
import { formatCurrency } from '@kompass/shared/utils/currency.utils';
```

### ❌ WRONG: Copy-Pasted Code

```typescript
// ❌ WRONG: Copy-pasted code in multiple files
// apps/backend/src/modules/invoice/invoice.service.ts
function formatCurrency(value: number): string {
  return new Intl.NumberFormat('de-DE', {
    style: 'currency',
    currency: 'EUR'
  }).format(value);
}

// apps/frontend/src/features/invoice/components/InvoiceCard.tsx
function formatCurrency(value: number): string {  // DUPLICATE!
  return new Intl.NumberFormat('de-DE', {
    style: 'currency',
    currency: 'EUR'
  }).format(value);
}
```

## Reusable UI Components

### ✅ CORRECT: Composing shadcn Components

```typescript
// apps/frontend/src/components/customer/CustomerCard.tsx
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';

interface CustomerCardProps {
  customer: Customer;
  onSelect: (id: string) => void;
}

export function CustomerCard({ customer, onSelect }: CustomerCardProps) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>{customer.companyName}</CardTitle>
      </CardHeader>
      <CardContent>
        <p>{customer.address.city}</p>
        <Badge>{customer.rating}</Badge>
        <Button onClick={() => onSelect(customer.id)}>View Details</Button>
      </CardContent>
    </Card>
  );
}
```

### ❌ WRONG: Creating Custom UI Components

```typescript
// ❌ WRONG: Custom card component instead of using shadcn
function CustomCard({ children }: { children: React.ReactNode }) {
  return (
    <div className="border rounded-lg p-4 shadow">
      {children}
    </div>
  ); // Should use shadcn Card component instead
}
```

## Component Reusability Patterns

### Feature-Specific Components

Components that are specific to a feature should stay in that feature directory:

```
apps/frontend/src/features/customer/components/
├── CustomerList.tsx          # Feature-specific
├── CustomerCard.tsx          # Feature-specific
└── CustomerForm.tsx         # Feature-specific
```

### Shared Feature Components

Components used by multiple features should be in shared components:

```
apps/frontend/src/components/
├── ui/                      # shadcn components
├── layout/                  # Layout components (Header, Sidebar)
└── common/                  # Common components (DataTable, SearchBar)
```

### ✅ CORRECT: Shared DataTable Component

```typescript
// apps/frontend/src/components/common/DataTable.tsx
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';

interface DataTableProps<T> {
  data: T[];
  columns: ColumnDef<T>[];
  onRowClick?: (row: T) => void;
}

export function DataTable<T>({ data, columns, onRowClick }: DataTableProps<T>) {
  return (
    <Table>
      <TableHeader>
        <TableRow>
          {columns.map(column => (
            <TableHead key={column.id}>{column.header}</TableHead>
          ))}
        </TableRow>
      </TableHeader>
      <TableBody>
        {data.map((row, index) => (
          <TableRow key={index} onClick={() => onRowClick?.(row)}>
            {columns.map(column => (
              <TableCell key={column.id}>
                {column.cell(row)}
              </TableCell>
            ))}
          </TableRow>
        ))}
      </TableBody>
    </Table>
  );
}

// Usage in CustomerList
import { DataTable } from '@/components/common/DataTable';

function CustomerList() {
  const columns = [
    { id: 'name', header: 'Company Name', cell: (c: Customer) => c.companyName },
    { id: 'vat', header: 'VAT Number', cell: (c: Customer) => c.vatNumber },
  ];

  return <DataTable data={customers} columns={columns} />;
}
```

## Code Extraction Checklist

Before creating new code, ask:

1. **Is this used in multiple places?** → Extract to shared
2. **Is this framework-agnostic?** → Can go in `packages/shared/`
3. **Is this a pure function?** → Extract to shared utils
4. **Is this a domain type?** → Extract to `packages/shared/src/types/`
5. **Is this validation logic?** → Extract to `packages/shared/src/validation/`
6. **Is this a constant?** → Extract to `packages/shared/src/constants/`

## Examples

### ✅ CORRECT: Well-Organized Reusable Code

```typescript
// packages/shared/src/utils/date-utils.ts
export function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('de-DE').format(date);
}

export function addDays(date: Date, days: number): Date {
  const result = new Date(date);
  result.setDate(result.getDate() + days);
  return result;
}

// packages/shared/src/types/entities/customer.ts
export interface Customer extends BaseEntity {
  type: 'customer';
  companyName: string;
  vatNumber?: string;
  // ...
}

// apps/frontend/src/hooks/useCustomer.ts
import { Customer } from '@kompass/shared/types/entities/customer';

export function useCustomer(id: string) {
  // Hook implementation
}
```

## References

- Architecture Documentation: `docs/architectur/Projekt KOMPASS – Architekturdokumentation (Zielarchitektur).md`
- Project Structure Rules: `.cursor/rules/project-structure.mdc`
