# Quality Gates & CI/CD Alignment

## Overview

This rule ensures that ALL code changes pass the same quality gates locally as in CI/CD. The pre-commit and pre-push hooks run EXACTLY the same checks as CI/CD, preventing any code from passing locally but failing in CI.

## Three-Layer Defense Strategy

### Layer 1: Pre-Commit Hook (Fast Feedback)
Runs on every commit for quick feedback:
- File organization checks (root directory, forbidden patterns, temporary files)
- lint-staged (ESLint --fix + Prettier --write on staged files only)
- Prettier format:check (read-only, fails if files need formatting)
- TypeScript type-check (fast incremental)
- Branch naming validation

**Location:** `.husky/pre-commit`

### Layer 2: Pre-Push Hook (Full Codebase, CI Parity)
Runs before push to ensure CI will pass:
- Branch naming validation
- Commit message validation (Linear issue IDs)
- Documentation update check (non-blocking warning)
- Full codebase lint (no --fix, matches CI)
- Prettier format:check (read-only, matches CI)
- TypeScript type-check (matches CI)
- Unit tests with coverage thresholds (matches CI)
- Security audit (matches CI)

**Location:** `.husky/pre-push`

### Layer 3: CI/CD Pipeline (Final Gate)
Runs all pre-push checks plus:
- Integration tests
- E2E tests
- Build verification
- Documentation guard
- Performance tests

**Location:** `.github/workflows/ci.yml`

## Quality Gate Requirements

### 1. ESLint

**CI/CD Command:** `pnpm lint` (no --fix)
- Runs turbo lint on all packages
- Backend: `eslint "{src,apps,libs,test}/**/*.ts"` (no --fix)
- Frontend: `eslint . --ext ts,tsx --report-unused-disable-directives` (no --fix)

**Local Auto-Fix:** Use `lint:fix` scripts for manual fixing
- Backend: `pnpm --filter @kompass/backend lint:fix`
- Frontend: `pnpm --filter @kompass/frontend lint:fix`

**lint-staged:** Uses `eslint --fix` directly on staged files (auto-fixes during commit)

### 2. Prettier Format Check

**CI/CD Command:** `pnpm format:check` (read-only)
- Checks all files but doesn't modify them
- Fails if any file needs formatting

**Local Auto-Fix:** `pnpm format` (writes changes)

**lint-staged:** Uses `prettier --write` on staged files (auto-fixes during commit)

### 3. TypeScript Type-Check

**CI/CD Command:** `pnpm type-check` (after building shared package)
- Runs `tsc --noEmit` on all packages
- Requires shared package to be built first

**Pre-commit:** Runs type-check for fast feedback
**Pre-push:** Runs type-check to match CI exactly

### 4. Unit Tests with Coverage

**CI/CD Commands:**
- Backend: `pnpm --filter @kompass/backend test:cov`
- Frontend: `pnpm --filter @kompass/frontend test:coverage`

**Coverage Thresholds:**
- Global: 80% branches, functions, lines, statements
- Backend services: 90% branches, functions, lines, statements
- Frontend components: 80% branches, functions, lines, statements

**Configuration:**
- Backend: `jest.config.js` (coverageThreshold)
- Frontend: `apps/frontend/vite.config.ts` (test.coverage.thresholds)

**Pre-push:** Runs tests with coverage to enforce thresholds

### 5. Security Audit

**CI/CD Command:** `pnpm audit --audit-level=high`
- Fails on high or critical vulnerabilities
- Blocks push/merge if vulnerabilities found

**Pre-push:** Runs security audit to match CI

### 6. Branch Naming

**Required Format:** `<type>/KOM-###-short-description`

**Types:** `feature`, `bugfix`, `hotfix`, `refactor`, `docs`, `test`, `chore`

**Examples:**
- ✅ `feature/KOM-123-customer-duplicate-detection`
- ✅ `bugfix/KOM-456-invoice-total-calculation`
- ❌ `feature/customer-feature` (missing Linear ID)
- ❌ `KOM-123-feature` (wrong format)

**Validation:** Pre-commit and pre-push hooks validate branch names

### 7. Commit Messages

**Required Format:** `<type>(KOM-###): <subject>`

**Types:** `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `chore`, `ci`, `revert`

**Examples:**
- ✅ `feat(KOM-123): add customer duplicate detection`
- ✅ `fix(KOM-456): correct invoice total calculation`
- ❌ `feat: add feature` (missing Linear ID)
- ❌ `feat KOM-123: add feature` (wrong format)

**Validation:** Pre-push hook validates commit messages

## Running Quality Checks Locally

### Quick Check (Pre-Commit Level)
```bash
# Run lint-staged on staged files
pnpm lint-staged

# Check formatting (read-only)
pnpm format:check

# Type-check
pnpm type-check
```

### Full Check (Pre-Push Level)
```bash
# Run all quality checks in CI order
./scripts/quality-check.sh
```

This script runs:
1. Build shared package
2. Lint (full codebase, no --fix)
3. Format check (read-only)
4. Type-check
5. Unit tests with coverage thresholds
6. Security audit

### Validate Hooks Match CI
```bash
# Validate that hooks match CI requirements
./scripts/validate-pre-commit.sh
```

## What to Do If Checks Fail

### ESLint Failures
```bash
# Auto-fix issues (if possible)
pnpm --filter @kompass/backend lint:fix
pnpm --filter @kompass/frontend lint:fix

# Or fix manually based on ESLint output
```

### Format Check Failures
```bash
# Auto-fix formatting
pnpm format

# Then commit again
```

### Type-Check Failures
```bash
# Fix TypeScript errors
# Check error messages for specific issues
# Common issues:
# - Missing type annotations
# - Type mismatches
# - Missing imports
```

### Test Coverage Failures
```bash
# Coverage below threshold
# Add tests to increase coverage
# Check coverage report: coverage/index.html

# Backend: 80% global, 90% for services
# Frontend: 80% global, 80% for components
```

### Security Audit Failures
```bash
# Attempt automatic fixes
pnpm audit --fix

# If automatic fix fails, update vulnerable packages manually
# Check pnpm audit output for specific packages
```

## Command Parity Checklist

Before committing/pushing, ensure these commands match CI exactly:

- [ ] `pnpm lint` - No --fix flag (CI doesn't auto-fix)
- [ ] `pnpm format:check` - Read-only check (CI doesn't modify files)
- [ ] `pnpm type-check` - After building shared package
- [ ] `pnpm --filter @kompass/backend test:cov` - With coverage thresholds
- [ ] `pnpm --filter @kompass/frontend test:coverage` - With coverage thresholds
- [ ] `pnpm audit --audit-level=high` - Same audit level as CI

## Coverage Thresholds Reference

### Backend (jest.config.js)
```javascript
coverageThreshold: {
  global: {
    branches: 80,
    functions: 80,
    lines: 80,
    statements: 80,
  },
  './apps/backend/src/modules/*/services/*.ts': {
    branches: 90,
    functions: 90,
    lines: 90,
    statements: 90,
  },
}
```

### Frontend (vite.config.ts)
```typescript
coverage: {
  thresholds: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
    './src/features/**/components/**/*.{ts,tsx}': {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
}
```

## Emergency Bypass

If you absolutely must bypass hooks (NOT RECOMMENDED):

```bash
# Skip pre-commit hook
git commit --no-verify

# Skip pre-push hook
git push --no-verify
```

**WARNING:** CI will still run all checks. If CI fails, you'll need to fix issues and push again. It's better to fix issues locally first.

## Best Practices

1. **Run quality checks before committing:**
   ```bash
   ./scripts/quality-check.sh
   ```

2. **Fix issues incrementally:**
   - Fix lint issues first
   - Fix formatting second
   - Fix type errors third
   - Add tests to meet coverage thresholds

3. **Use lint-staged for auto-fixes:**
   - Staged files are auto-fixed during commit
   - Unstaged files are not modified

4. **Keep hooks in sync with CI:**
   - Run validation script: `./scripts/validate-pre-commit.sh`
   - Update hooks when CI changes
   - Document any differences (should be none)

5. **Monitor coverage:**
   - Check coverage reports regularly
   - Add tests when coverage drops
   - Aim for 80%+ coverage on new code

## References

- CI/CD Workflow: `.github/workflows/ci.yml`
- Pre-Commit Hook: `.husky/pre-commit`
- Pre-Push Hook: `.husky/pre-push`
- Quality Check Script: `scripts/quality-check.sh`
- Validation Script: `scripts/validate-pre-commit.sh`
- Coverage Config: `jest.config.js`, `apps/frontend/vite.config.ts`
