version: '3.8'

# KOMPASS Docker Compose - Staging Environment
# Override for staging-specific configuration

services:
  couchdb:
    environment:
      - COUCHDB_USER=${STAGING_COUCHDB_USER}
      - COUCHDB_PASSWORD=${STAGING_COUCHDB_PASSWORD}
    volumes:
      - /opt/kompass/staging/data/couchdb:/opt/couchdb/data
      - /opt/kompass/staging/config/couchdb:/opt/couchdb/etc/local.d
    restart: always

  meilisearch:
    environment:
      - MEILI_MASTER_KEY=${STAGING_MEILI_MASTER_KEY}
      - MEILI_ENV=production
    volumes:
      - /opt/kompass/staging/data/meilisearch:/meili_data
    restart: always

  keycloak:
    environment:
      - KEYCLOAK_ADMIN=${STAGING_KEYCLOAK_ADMIN}
      - KEYCLOAK_ADMIN_PASSWORD=${STAGING_KEYCLOAK_ADMIN_PASSWORD}
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://${STAGING_POSTGRES_HOST}:5432/keycloak
      - KC_DB_USERNAME=${STAGING_POSTGRES_USER}
      - KC_DB_PASSWORD=${STAGING_POSTGRES_PASSWORD}
      - KC_HOSTNAME=${STAGING_HOSTNAME}
      - KC_HOSTNAME_STRICT=true
      - KC_HOSTNAME_STRICT_HTTPS=true
      - KC_PROXY=edge
    command:
      - start
      - --optimized
      - --http-enabled=false
      - --https-certificate-file=/opt/keycloak/conf/tls.crt
      - --https-certificate-key-file=/opt/keycloak/conf/tls.key
    volumes:
      - /opt/kompass/staging/certs:/opt/keycloak/conf
      - /opt/kompass/staging/data/keycloak:/opt/keycloak/data
    restart: always

  neo4j:
    environment:
      - NEO4J_AUTH=${STAGING_NEO4J_AUTH:-neo4j/stagingpassword}
    volumes:
      - /opt/kompass/staging/data/neo4j:/data
      - /opt/kompass/staging/logs/neo4j:/logs
    restart: always

  whisper:
    environment:
      - ASR_MODEL=${STAGING_WHISPER_MODEL:-base}
    volumes:
      - /opt/kompass/staging/data/whisper:/root/.cache/whisper
    restart: always

  n8n:
    environment:
      - N8N_BASIC_AUTH_ACTIVE=${STAGING_N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${STAGING_N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${STAGING_N8N_BASIC_AUTH_PASSWORD}
      - N8N_HOST=${STAGING_N8N_HOST:-n8n.staging.kompass.de}
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=${STAGING_N8N_WEBHOOK_URL:-https://n8n.staging.kompass.de}
    volumes:
      - /opt/kompass/staging/data/n8n:/home/node/.n8n
    restart: always

  backend:
    image: ghcr.io/${GITHUB_REPOSITORY}/backend:${IMAGE_TAG:-staging}
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_URL=${STAGING_DATABASE_URL}
      - COUCHDB_USER=${STAGING_COUCHDB_USER}
      - COUCHDB_PASSWORD=${STAGING_COUCHDB_PASSWORD}
      - COUCHDB_DATABASE=kompass_staging
      - MEILISEARCH_URL=${STAGING_MEILISEARCH_URL}
      - MEILISEARCH_MASTER_KEY=${STAGING_MEILI_MASTER_KEY}
      - KEYCLOAK_URL=${STAGING_KEYCLOAK_URL}
      - KEYCLOAK_REALM=kompass-staging
      - KEYCLOAK_CLIENT_ID=kompass-api-staging
      - KEYCLOAK_CLIENT_SECRET=${STAGING_KEYCLOAK_CLIENT_SECRET}
      - JWT_SECRET=${STAGING_JWT_SECRET}
      - ALLOWED_ORIGINS=${STAGING_ALLOWED_ORIGINS}
      - LOG_LEVEL=info
      # Neo4j connection
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${STAGING_NEO4J_PASSWORD:-stagingpassword}
      # Whisper API
      - WHISPER_API_URL=${STAGING_WHISPER_API_URL:-http://whisper:9000}
      # n8n webhook URL
      - N8N_WEBHOOK_URL=${STAGING_N8N_WEBHOOK_URL:-https://n8n.staging.kompass.de}
      # Feature flags (injected from GitHub Secrets)
      - AI_N8N_ENABLED=${STAGING_AI_N8N_ENABLED:-false}
      - AI_RAG_ENABLED=${STAGING_AI_RAG_ENABLED:-false}
      - AI_ML_ENABLED=${STAGING_AI_ML_ENABLED:-false}
    restart: always
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  frontend:
    image: ghcr.io/${GITHUB_REPOSITORY}/frontend:${IMAGE_TAG:-staging}
    environment:
      - VITE_API_URL=${STAGING_API_URL}
      # Feature flags (for frontend feature toggles)
      - VITE_AI_N8N_ENABLED=${STAGING_AI_N8N_ENABLED:-false}
      - VITE_AI_RAG_ENABLED=${STAGING_AI_RAG_ENABLED:-false}
      - VITE_AI_ML_ENABLED=${STAGING_AI_ML_ENABLED:-false}
    restart: always
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

networks:
  kompass-network:
    driver: bridge

volumes:
  couchdb-data:
    driver: local
  couchdb-config:
    driver: local
  meilisearch-data:
    driver: local
  keycloak-data:
    driver: local
